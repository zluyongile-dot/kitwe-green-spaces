<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Kitwe Green Space Map | Interactive GIS System</title>
    
    <!-- External CSS Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.0.0/Control.FullScreen.css" />
    
    <!-- Professional Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        :root {
            /* Modern GIS/Environmental Color Palette */
            --primary-color: #1B5E20;
            --primary-light: #4CAF50;
            --primary-dark: #0D4E14;
            --secondary-color: #2E7D32;
            --accent-color: #66BB6A;
            --success-color: #4CAF50;
            --warning-color: #FF8F00;
            --error-color: #D32F2F;
            --info-color: #1976D2;
            
            /* Neutral Colors */
            --background-primary: #FAFAFA;
            --background-secondary: #FFFFFF;
            --background-tertiary: #F5F5F5;
            --surface-color: #FFFFFF;
            --surface-elevated: #FFFFFF;
            
            /* Text Colors */
            --text-primary: #212121;
            --text-secondary: #757575;
            --text-tertiary: #9E9E9E;
            --text-inverse: #FFFFFF;
            
            /* Border Colors */
            --border-light: #E0E0E0;
            --border-medium: #BDBDBD;
            --border-dark: #9E9E9E;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
            --shadow-md: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
            --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.19), 0 6px 6px rgba(0, 0, 0, 0.23);
            --shadow-xl: 0 14px 28px rgba(0, 0, 0, 0.25), 0 10px 10px rgba(0, 0, 0, 0.22);
            
            /* Layout */
            --sidebar-width: 400px;
            --navbar-height: 72px;
            --border-radius-sm: 6px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            
            /* Typography */
            --font-family-primary: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-family-mono: 'JetBrains Mono', 'SF Mono', Monaco, 'Cascadia Code', monospace;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-weight-light: 300;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-family-primary);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-normal);
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--background-primary);
            overflow-x: hidden !important;
            overflow-y: auto !important;
            height: auto !important;
            min-height: 100vh !important;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Override any conflicting styles from style.css */
        body {
            position: static !important;
            max-height: none !important;
        }
        
        /* Modern Navigation */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2000;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%) !important;
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-md);
            height: var(--navbar-height);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .navbar-brand {
            color: var(--text-inverse) !important;
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-lg);
            letter-spacing: -0.025em;
        }
        
        .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-sm);
            transition: all var(--transition-fast);
            padding: var(--spacing-sm) var(--spacing-md) !important;
            margin: 0 var(--spacing-xs);
            border-radius: var(--border-radius-sm);
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }
        
        .navbar-nav .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(-100%);
            transition: transform var(--transition-fast);
        }
        
        .navbar-nav .nav-link:hover::before,
        .navbar-nav .nav-link.active::before {
            transform: translateX(0);
        }
        
        .navbar-nav .nav-link:hover,
        .navbar-nav .nav-link.active {
            color: var(--text-inverse) !important;
            background: rgba(255, 255, 255, 0.15);
            border-radius: var(--border-radius-sm);
            transform: translateY(-1px);
        }
        
        /* Modern Layout */
        .main-container {
            display: block;
            min-height: calc(100vh - var(--navbar-height));
            margin-top: var(--navbar-height);
            overflow: visible !important;
            height: auto !important;
            position: relative;
            background: var(--background-primary);
        }
        
        /* Modern Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--surface-color);
            border-right: 1px solid var(--border-light);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            transition: all var(--transition-normal);
            z-index: 1100;
            position: fixed;
            left: 0;
            top: var(--navbar-height);
            height: calc(100vh - var(--navbar-height));
            backdrop-filter: blur(20px);
            overflow: hidden;
        }
        
        .sidebar.collapsed {
            transform: translateX(-100%);
            visibility: hidden;
        }
        
        /* Sidebar Header - Fixed */
        .sidebar-header {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--border-light);
            background: linear-gradient(135deg, var(--surface-color) 0%, var(--background-tertiary) 100%);
            flex-shrink: 0;
            overflow-y: auto;
            max-height: 50vh;
        }
        
        /* Sidebar Content - Scrollable */
        .sidebar-content {
            flex: 1;
            padding: var(--spacing-xl);
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }
        
        .logo-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: var(--spacing-md);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }
        
        .logo-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
            100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        }
        
        .logo-text h3 {
            color: var(--text-primary);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            margin: 0;
            letter-spacing: -0.025em;
        }
        
        .logo-text p {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            margin: 0;
            letter-spacing: 0.025em;
        }
        
        /* Modern Search */
        .search-container {
            position: relative;
            margin-bottom: var(--spacing-md);
        }
        
        .search-input {
            width: 100%;
            padding: var(--spacing-md) var(--spacing-2xl) var(--spacing-md) var(--spacing-2xl);
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius-md);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            transition: all var(--transition-fast);
            background: var(--surface-color);
            color: var(--text-primary);
            font-family: var(--font-family-primary);
        }
        
        .search-input::placeholder {
            color: var(--text-tertiary);
            font-weight: var(--font-weight-normal);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(27, 94, 32, 0.1);
            background: var(--surface-elevated);
        }
        
        .search-icon {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            font-size: var(--font-size-sm);
            transition: color var(--transition-fast);
        }
        
        .search-input:focus + .search-icon {
            color: var(--primary-color);
        }
        
        .search-clear {
            position: absolute;
            right: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: 50%;
            transition: all var(--transition-fast);
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .search-clear:hover {
            background: var(--background-tertiary);
            color: var(--primary-color);
            transform: translateY(-50%) scale(1.1);
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--surface-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-xl);
            max-height: 320px;
            overflow-y: auto;
            z-index: 1000;
            backdrop-filter: blur(20px);
        }
        
        .search-result-item {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        
        .search-result-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary-color);
            transform: scaleY(0);
            transition: transform var(--transition-fast);
        }
        
        .search-result-item:hover::before,
        .search-result-item.highlighted::before {
            transform: scaleY(1);
        }
        
        .search-result-item:hover,
        .search-result-item.highlighted {
            background-color: var(--background-tertiary);
            transform: translateX(4px);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        /* Modern Navbar Responsive */
        .navbar-nav {
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            max-width: calc(100vw - 240px);
        }
        
        .navbar-nav::-webkit-scrollbar {
            display: none;
        }
        
        .navbar-nav .nav-item {
            white-space: nowrap;
            flex-shrink: 0;
            min-width: fit-content;
        }
        
        .navbar-nav .nav-link {
            padding: var(--spacing-sm) var(--spacing-md) !important;
            margin: 0 var(--spacing-xs);
            font-size: var(--font-size-sm);
            min-width: fit-content;
        }
        
        /* Mobile navbar improvements */
        @media (max-width: 991px) {
            .navbar-nav {
                max-width: 100%;
                padding: var(--spacing-md) 0;
            }
            
            .navbar-nav .nav-item {
                margin: var(--spacing-xs) 0;
            }
            
            .navbar-nav .nav-link {
                padding: var(--spacing-md) var(--spacing-lg) !important;
                border-radius: var(--border-radius-sm);
                margin: var(--spacing-xs) 0;
            }
        }
        
        /* Modern Sidebar Content */
        .sidebar-content {
            flex: 1;
            padding: var(--spacing-xl);
            overflow-y: auto;
            overflow-x: hidden;
            max-height: calc(100vh - var(--navbar-height) - 200px);
        }
        
        /* Modern Map Container */
        .map-container {
            flex: 1;
            position: relative;
            background: var(--background-tertiary);
            min-height: calc(100vh - var(--navbar-height));
            margin-left: var(--sidebar-width);
            transition: margin-left var(--transition-normal);
        }
        
        .map-container.sidebar-hidden {
            margin-left: 0;
        }
        
        /* Sidebar scrollbar styling */
        .sidebar-header::-webkit-scrollbar,
        .sidebar-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .sidebar-header::-webkit-scrollbar-track,
        .sidebar-content::-webkit-scrollbar-track {
            background: var(--background-tertiary);
            border-radius: 4px;
        }
        
        .sidebar-header::-webkit-scrollbar-thumb,
        .sidebar-content::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 4px;
            transition: background var(--transition-fast);
        }
        
        .sidebar-header::-webkit-scrollbar-thumb:hover,
        .sidebar-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
        
        /* Map Introduction Styles */
        .map-intro {
            background: linear-gradient(135deg, var(--surface-elevated) 0%, var(--background-tertiary) 100%);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            border: 1px solid var(--border-light);
            position: relative;
        }
        
        .intro-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
        }
        
        .intro-description {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: var(--spacing-md);
        }
        
        .intro-stats {
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap;
        }
        
        .stat-badge {
            background: rgba(27, 94, 32, 0.1);
            color: var(--primary-color);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            display: flex;
            align-items: center;
        }
        
        .help-toggle {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            background: var(--primary-color);
            color: var(--text-inverse);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: var(--font-size-sm);
        }
        
        .help-toggle:hover {
            background: var(--secondary-color);
            transform: scale(1.1);
        }
        
        /* Help Panel Styles */
        .help-panel {
            background: var(--surface-elevated);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            animation: fadeIn 0.3s ease;
        }
        
        .help-title {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--primary-color);
            margin-bottom: var(--spacing-md);
        }
        
        .help-section {
            margin-bottom: var(--spacing-md);
        }
        
        .help-section h6 {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }
        
        .help-section p {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.4;
        }
        
        /* Enhanced Search Styles */
        .search-options {
            position: absolute;
            right: 48px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 2px;
        }
        
        .search-option-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 12px;
        }
        
        .search-option-btn:hover,
        .search-option-btn.active {
            background: var(--primary-color);
            color: var(--text-inverse);
        }
        
        /* Enhanced Filter Styles */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }
        
        .help-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: 50%;
            transition: all var(--transition-fast);
        }
        
        .help-btn:hover {
            background: var(--background-tertiary);
            color: var(--primary-color);
        }
        
        .quick-filters {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-lg);
        }
        
        .quick-filter-btn {
            background: var(--surface-color);
            border: 2px solid var(--border-light);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }
        
        .quick-filter-btn:hover {
            border-color: var(--primary-color);
            background: rgba(27, 94, 32, 0.05);
        }
        
        .quick-filter-btn.active {
            background: var(--primary-color);
            color: var(--text-inverse);
            border-color: var(--primary-color);
        }
        
        .quick-filter-btn i {
            font-size: var(--font-size-base);
        }
        
        .detailed-filters {
            border-top: 1px solid var(--border-light);
            padding-top: var(--spacing-lg);
        }
        
        .tooltip-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            margin-left: var(--spacing-xs);
            padding: 2px;
            border-radius: 50%;
            transition: all var(--transition-fast);
            font-size: 12px;
        }
        
        .tooltip-btn:hover {
            background: var(--background-tertiary);
            color: var(--primary-color);
        }
        
        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: var(--font-size-xs);
            color: var(--text-tertiary);
            margin-top: var(--spacing-xs);
        }
        
        /* Checkbox Group Styles */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-fast);
            font-size: var(--font-size-sm);
        }
        
        .checkbox-item:hover {
            background: var(--background-tertiary);
        }
        
        .checkbox-item input[type="checkbox"] {
            display: none;
        }
        
        .checkmark {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-medium);
            border-radius: 4px;
            margin-right: var(--spacing-sm);
            position: relative;
            transition: all var(--transition-fast);
        }
        
        .checkbox-item input[type="checkbox"]:checked + .checkmark {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .checkbox-item input[type="checkbox"]:checked + .checkmark::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-inverse);
            font-size: 12px;
            font-weight: bold;
        }
        
        /* Accessibility Settings Styles */
        .setting-item {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-fast);
        }
        
        .setting-item:hover {
            background: var(--background-tertiary);
        }
        
        .setting-label {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            margin: 0;
        }
        
        .setting-checkbox {
            margin-right: var(--spacing-sm);
            transform: scale(1.2);
        }
        
        .setting-text {
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }
        
        .setting-description {
            color: var(--text-secondary);
            font-size: var(--font-size-xs);
            line-height: 1.3;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-xs) 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .shortcut-item:last-child {
            border-bottom: none;
        }
        
        .shortcut-item kbd {
            background: var(--background-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: var(--font-size-xs);
            font-family: var(--font-family-mono);
        }
        
        /* High Contrast Mode */
        .high-contrast {
            --primary-color: #000000;
            --secondary-color: #333333;
            --background-primary: #FFFFFF;
            --background-secondary: #F0F0F0;
            --text-primary: #000000;
            --text-secondary: #333333;
            --border-light: #000000;
            --border-medium: #333333;
        }
        
        .high-contrast .leaflet-tile {
            filter: contrast(150%) brightness(110%);
        }
        
        /* Large Text Mode */
        .large-text {
            --font-size-xs: 0.875rem;
            --font-size-sm: 1rem;
            --font-size-base: 1.125rem;
            --font-size-lg: 1.375rem;
            --font-size-xl: 1.5rem;
        }
        
        /* Reduced Motion Mode */
        .reduced-motion * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
        
        /* Color Blind Friendly Mode */
        .color-blind-mode .legend-color,
        .color-blind-mode .custom-marker {
            border: 2px solid #000;
            position: relative;
        }
        
        .color-blind-mode .legend-color::after {
            content: attr(data-pattern);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8px;
            color: #000;
            font-weight: bold;
        }
        
        /* Modern Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }
        
        .stat-card {
            background: var(--surface-elevated);
            padding: var(--spacing-lg) var(--spacing-md);
            border-radius: var(--border-radius-md);
            text-align: center;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transform: scaleX(0);
            transition: transform var(--transition-fast);
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }
        
        .stat-card:hover::before {
            transform: scaleX(1);
        }
        
        .stat-number {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--primary-color);
            margin-bottom: var(--spacing-xs);
            font-family: var(--font-family-mono);
        }
        
        .stat-label {
            font-size: var(--font-size-xs);
            color: var(--text-secondary);
            font-weight: var(--font-weight-medium);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Modern Filter Section */
        .filter-section {
            background: var(--surface-elevated);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-xl);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }
        
        .filter-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
        }
        
        .section-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .section-title i {
            color: var(--primary-color);
            font-size: var(--font-size-base);
        }
        
        .filter-group {
            margin-bottom: var(--spacing-lg);
        }
        
        .filter-label {
            display: block;
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
            font-size: var(--font-size-sm);
            letter-spacing: 0.025em;
        }
        
        .filter-select {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            background: var(--surface-color);
            color: var(--text-primary);
            transition: all var(--transition-fast);
            font-family: var(--font-family-primary);
            cursor: pointer;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(27, 94, 32, 0.1);
            background: var(--surface-elevated);
        }
        
        .filter-select:hover {
            border-color: var(--border-medium);
        }
        
        /* Modern Range Slider */
        .range-container {
            margin-top: var(--spacing-md);
        }
        
        .range-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
            font-size: var(--font-size-sm);
        }
        
        .range-value {
            font-weight: var(--font-weight-semibold);
            color: var(--primary-color);
            font-family: var(--font-family-mono);
        }
        
        #areaRange {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--border-light);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }
        
        #areaRange::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-fast);
        }
        
        #areaRange::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }
        
        #areaRange::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow-md);
        }
        
        /* Modern Action Buttons */
        .action-buttons {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }
        
        .btn-primary {
            flex: 1;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--border-radius-md);
            color: var(--text-inverse);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            transition: all var(--transition-fast);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            font-family: var(--font-family-primary);
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left var(--transition-slow);
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-secondary {
            flex: 1;
            background: var(--surface-color);
            border: 2px solid var(--border-light);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--border-radius-md);
            color: var(--text-primary);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            transition: all var(--transition-fast);
            cursor: pointer;
            font-family: var(--font-family-primary);
        }
        
        .btn-secondary:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .btn-secondary:active {
            transform: translateY(0);
        }
        
        /* Modern Legend */
        .legend-container {
            background: var(--surface-elevated);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }
        
        .legend-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-fast);
        }
        
        .legend-item:hover {
            background: var(--background-tertiary);
            transform: translateX(4px);
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            box-shadow: var(--shadow-sm);
            border: 2px solid var(--surface-color);
            flex-shrink: 0;
        }
        
        .legend-label {
            font-size: var(--font-size-sm);
            color: var(--text-primary);
            font-weight: var(--font-weight-medium);
        }
        
        /* Modern Map Container */
        #map {
            width: 100%;
            height: calc(100vh - var(--navbar-height));
            border-radius: 0;
        }
        
        /* Modern Sidebar Toggle */
        .sidebar-toggle {
            position: absolute;
            top: var(--spacing-lg);
            left: var(--spacing-lg);
            z-index: 1200;
            background: var(--surface-elevated);
            border: none;
            width: 56px;
            height: 56px;
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: all var(--transition-normal);
            font-size: var(--font-size-lg);
            color: var(--primary-color);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
        }
        
        .sidebar-toggle:hover {
            background: var(--primary-color);
            color: var(--text-inverse);
            transform: scale(1.05);
            box-shadow: var(--shadow-xl);
        }
        
        .sidebar-toggle:active {
            transform: scale(0.95);
        }
        
        .sidebar-toggle.sidebar-open {
            left: calc(var(--sidebar-width) + var(--spacing-lg));
        }
        
        .sidebar-toggle.sidebar-closed {
            left: var(--spacing-lg);
            background: var(--primary-color);
            color: var(--text-inverse);
        }
        
        .sidebar-toggle.sidebar-closed:hover {
            background: var(--secondary-color);
            transform: scale(1.1);
        }
        
        /* Animate sidebar toggle position */
        .sidebar-toggle {
            transition: all var(--transition-normal);
        }
        
        /* Modern tooltip */
        .sidebar-toggle::after {
            content: attr(data-tooltip);
            position: absolute;
            left: 68px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--text-primary);
            color: var(--text-inverse);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-sm);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-fast);
            box-shadow: var(--shadow-md);
        }
        
        .sidebar-toggle:hover::after {
            opacity: 1;
        }
        
        /* Modern Map Controls */
        .map-controls {
            position: absolute;
            bottom: var(--spacing-xl);
            right: var(--spacing-xl);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            z-index: 1000;
        }
        
        .control-btn {
            width: 56px;
            height: 56px;
            background: var(--surface-elevated);
            border: none;
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: var(--font-size-lg);
            color: var(--primary-color);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            position: relative;
            overflow: hidden;
        }
        
        .control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(27, 94, 32, 0.1), transparent);
            transition: left var(--transition-slow);
        }
        
        .control-btn:hover::before {
            left: 100%;
        }
        
        .control-btn:hover {
            background: var(--primary-color);
            color: var(--text-inverse);
            transform: scale(1.05);
            box-shadow: var(--shadow-xl);
        }
        
        .control-btn:active {
            transform: scale(0.95);
        }
        
        /* Enhanced Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(250, 250, 250, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1900;
            flex-direction: column;
            gap: var(--spacing-xl);
        }
        
        .loading-container {
            text-align: center;
            max-width: 400px;
            padding: var(--spacing-2xl);
            background: var(--surface-elevated);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-light);
        }
        
        .spinner-container {
            position: relative;
            width: 80px;
            height: 80px;
            margin: 0 auto var(--spacing-xl);
        }
        
        .spinner {
            width: 80px;
            height: 80px;
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .spinner-inner {
            position: absolute;
            top: 12px;
            left: 12px;
            width: 56px;
            height: 56px;
            border: 3px solid transparent;
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1.5s linear infinite reverse;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-content {
            text-align: center;
        }
        
        .loading-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }
        
        .loading-text {
            font-size: var(--font-size-base);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xl);
            font-weight: var(--font-weight-medium);
        }
        
        .progress-container {
            margin-bottom: var(--spacing-xl);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-light);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: var(--spacing-sm);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 4px;
            width: 0%;
            transition: width var(--transition-slow);
            position: relative;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        .progress-text {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--primary-color);
            font-family: var(--font-family-mono);
        }
        
        .loading-steps {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
            text-align: left;
        }
        
        .step {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-fast);
            opacity: 0.5;
        }
        
        .step.active {
            opacity: 1;
            background: rgba(27, 94, 32, 0.1);
            color: var(--primary-color);
        }
        
        .step.completed {
            opacity: 1;
            color: var(--success-color);
        }
        
        .step i {
            width: 20px;
            text-align: center;
            font-size: var(--font-size-sm);
        }
        
        .step span {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
        }
        
        /* Error State */
        .error-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(250, 250, 250, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1900;
            flex-direction: column;
        }
        
        .error-container {
            text-align: center;
            max-width: 500px;
            padding: var(--spacing-2xl);
            background: var(--surface-elevated);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-light);
        }
        
        .error-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--error-color), #FF5722);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--spacing-xl);
            color: var(--text-inverse);
            font-size: var(--font-size-2xl);
        }
        
        .error-title {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--error-color);
            margin-bottom: var(--spacing-sm);
        }
        
        .error-message {
            font-size: var(--font-size-base);
            color: var(--text-secondary);
            margin-bottom: var(--spacing-xl);
            line-height: 1.6;
        }
        
        .error-actions {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .error-btn {
            padding: var(--spacing-md) var(--spacing-xl);
            border-radius: var(--border-radius-md);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
            font-family: var(--font-family-primary);
        }
        
        .error-btn-primary {
            background: var(--primary-color);
            color: var(--text-inverse);
        }
        
        .error-btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .error-btn-secondary {
            background: var(--surface-color);
            color: var(--text-primary);
            border: 2px solid var(--border-light);
        }
        
        .error-btn-secondary:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        /* Network Status Indicator */
        .network-status {
            position: fixed;
            top: calc(var(--navbar-height) + var(--spacing-md));
            right: var(--spacing-md);
            z-index: 2100;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-md);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
            transition: all var(--transition-fast);
            transform: translateX(100%);
        }
        
        .network-status.show {
            transform: translateX(0);
        }
        
        .network-status.online {
            background: rgba(76, 175, 80, 0.9);
            color: var(--text-inverse);
        }
        
        .network-status.offline {
            background: rgba(244, 67, 54, 0.9);
            color: var(--text-inverse);
        }
        
        .network-status.reconnecting {
            background: rgba(255, 152, 0, 0.9);
            color: var(--text-inverse);
        }
        
        /* Button Loading States */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .btn-loading .btn-text {
            opacity: 0;
        }
        
        /* Modern Responsive Design */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 100%;
                --navbar-height: 64px;
                --spacing-xl: 20px;
                --spacing-lg: 16px;
            }
            
            body {
                overflow-x: hidden;
            }
            
            .main-container {
                flex-direction: column;
                min-height: auto;
            }
            
            .sidebar {
                width: 100%;
                position: fixed;
                height: calc(100vh - var(--navbar-height));
                z-index: 1500;
                top: var(--navbar-height);
                transform: translateX(-100%);
            }
            
            .sidebar:not(.collapsed) {
                transform: translateX(0);
            }
            
            .sidebar.collapsed {
                transform: translateX(-100%);
            }
            
            .map-container {
                width: 100%;
                height: calc(100vh - var(--navbar-height));
                margin-left: 0;
            }
            
            #map {
                height: 100%;
            }
            
            .sidebar-content {
                max-height: calc(100vh - var(--navbar-height) - 150px);
                padding: var(--spacing-lg);
            }
            
            .sidebar-header {
                padding: var(--spacing-lg);
            }
            
            .sidebar-toggle {
                left: var(--spacing-md);
                top: var(--spacing-md);
                width: 48px;
                height: 48px;
                font-size: var(--font-size-base);
            }
            
            .sidebar-toggle.sidebar-open {
                left: var(--spacing-md);
                background: var(--primary-color);
                color: var(--text-inverse);
            }
            
            .sidebar-toggle.sidebar-closed {
                left: var(--spacing-md);
                background: var(--primary-color);
                color: var(--text-inverse);
            }
            
            .sidebar-toggle::after {
                display: none; /* Hide tooltip on mobile */
            }
            
            .map-controls {
                bottom: var(--spacing-lg);
                right: var(--spacing-lg);
            }
            
            .control-btn {
                width: 48px;
                height: 48px;
                font-size: var(--font-size-base);
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: var(--spacing-sm);
            }
            
            .stat-card {
                padding: var(--spacing-md) var(--spacing-sm);
            }
            
            .stat-number {
                font-size: var(--font-size-xl);
            }
            
            .legend-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }
            
            .action-buttons {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
        }
        
        @media (max-width: 480px) {
            :root {
                --spacing-xl: 16px;
                --spacing-lg: 12px;
                --sidebar-width: 100%;
            }
            
            .navbar-brand {
                font-size: var(--font-size-base);
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }
            
            .filter-section,
            .legend-container {
                padding: var(--spacing-lg);
            }
            
            .sidebar-header {
                padding: var(--spacing-md);
            }
            
            .sidebar-content {
                padding: var(--spacing-md);
            }
        }
        
        /* Modern Utility Classes */
        .d-none {
            display: none !important;
        }
        
        /* Modern Modal Improvements */
        .modal-dialog {
            max-width: 920px;
            margin: var(--spacing-xl) auto;
        }
        
        .modal-content {
            border: none;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-xl);
            backdrop-filter: blur(20px);
        }
        
        .modal-header {
            border-bottom: 1px solid var(--border-light);
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        }
        
        .modal-body {
            max-height: 70vh;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            padding: var(--spacing-xl);
        }
        
        .modal-footer {
            border-top: 1px solid var(--border-light);
            padding: var(--spacing-xl);
            border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
        }
        
        /* Modern Scrolling */
        html {
            scroll-behavior: smooth;
            overflow-y: auto !important;
            height: auto !important;
        }
        
        .modal-open {
            overflow: auto !important;
        }
        
        .modal-open body {
            overflow: auto !important;
            height: auto !important;
            position: static !important;
        }
        
        /* Modern Custom Scrollbars */
        .modal-body::-webkit-scrollbar,
        .sidebar-content::-webkit-scrollbar,
        .search-results::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-body::-webkit-scrollbar-track,
        .sidebar-content::-webkit-scrollbar-track,
        .search-results::-webkit-scrollbar-track {
            background: var(--background-tertiary);
            border-radius: 4px;
        }
        
        .modal-body::-webkit-scrollbar-thumb,
        .sidebar-content::-webkit-scrollbar-thumb,
        .search-results::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 4px;
            transition: background var(--transition-fast);
        }
        
        .modal-body::-webkit-scrollbar-thumb:hover,
        .sidebar-content::-webkit-scrollbar-thumb:hover,
        .search-results::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
        
        /* Modern Leaflet Popup Styling */
        .leaflet-popup-content {
            overflow-y: auto !important;
            max-height: 450px;
            margin: 0;
            font-family: var(--font-family-primary);
        }
        
        .leaflet-popup-content-wrapper {
            overflow: visible !important;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-xl);
            border: 1px solid var(--border-light);
        }
        
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-xl);
        }
        
        .custom-popup .leaflet-popup-content {
            margin: 0;
            overflow-y: auto;
            max-height: 500px;
            font-size: var(--font-size-sm);
            line-height: 1.5;
        }
        
        .custom-popup .leaflet-popup-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-popup .leaflet-popup-content::-webkit-scrollbar-track {
            background: var(--background-tertiary);
            border-radius: 3px;
        }
        
        .custom-popup .leaflet-popup-content::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }
        
        /* Modern Leaflet Controls */
        .leaflet-control-zoom a {
            background: var(--surface-elevated) !important;
            border: 1px solid var(--border-light) !important;
            color: var(--primary-color) !important;
            font-weight: var(--font-weight-semibold) !important;
            transition: all var(--transition-fast) !important;
        }
        
        .leaflet-control-zoom a:hover {
            background: var(--primary-color) !important;
            color: var(--text-inverse) !important;
            border-color: var(--primary-color) !important;
        }
        
        .leaflet-control-layers {
            background: var(--surface-elevated) !important;
            border: 1px solid var(--border-light) !important;
            border-radius: var(--border-radius-md) !important;
            box-shadow: var(--shadow-md) !important;
        }
        
        .leaflet-control-layers-toggle {
            background: var(--surface-elevated) !important;
            border-radius: var(--border-radius-md) !important;
        }
        
        /* Modern Custom Marker Styling */
        .custom-marker {
            filter: drop-shadow(var(--shadow-sm));
        }
        
        .custom-marker:hover {
            filter: drop-shadow(var(--shadow-md));
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="home.html">
                <div class="logo-icon me-3" style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-tree text-white" style="font-size: 20px;"></i>
                </div>
                <div>
                    <span class="fw-bold">Kitwe Green Spaces</span>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" style="border-color: rgba(255,255,255,0.3);">
                <span class="navbar-toggler-icon" style="filter: invert(1);"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link px-3" href="home.html">
                            <i class="fas fa-home me-2"></i>Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active px-3" href="index.html">
                            <i class="fas fa-map-marked-alt me-2"></i>Map
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link px-3" href="simpledashboard.html">
                            <i class="fas fa-chart-bar me-2"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link px-3" href="feedback.html">
                            <i class="fas fa-comment-dots me-2"></i>Feedback
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link px-3" href="documentation.html">
                            <i class="fas fa-book me-2"></i>Documentation
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link px-3" href="about-green-spaces.html">
                            <i class="fas fa-info-circle me-2"></i>About Green Spaces
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle px-3" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-tools me-2"></i>Tools
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="environmental-monitoring.html"><i class="fas fa-leaf me-2"></i>Environmental Monitor</a></li>
                            <li><a class="dropdown-item" href="advanced-stats.html"><i class="fas fa-chart-line me-2"></i>Advanced Statistics</a></li>
                            <li><a class="dropdown-item" href="report-generator.html"><i class="fas fa-file-pdf me-2"></i>Generate Report</a></li>
                            <li><a class="dropdown-item" href="bibliography.html"><i class="fas fa-book me-2"></i>Bibliography</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Network Status Indicator -->
    <div class="network-status" id="networkStatus">
        <i class="fas fa-wifi"></i>
        <span id="networkStatusText">Online</span>
    </div>

    <div class="main-container">
        <!-- Left Sidebar -->
        <div class="sidebar" id="sidebar">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="logo-container">
                        <div class="logo-icon">
                            <i class="fas fa-tree text-white" style="font-size: 24px;"></i>
                        </div>
                        <div class="logo-text">
                            <h3>Green Spaces</h3>
                            <p>Interactive GIS Map</p>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary d-md-none" id="sidebarCloseBtn" title="Close Sidebar">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Map Introduction -->
                <div class="map-intro">
                    <div class="intro-content">
                        <h4 class="intro-title">
                            <i class="fas fa-map-marked-alt me-2"></i>
                            Kitwe Green Spaces Map
                        </h4>
                        <p class="intro-description">
                            This interactive map shows parks, forests, gardens, and recreational areas throughout Kitwe. 
                            Use the filters below to explore different types of green spaces and find locations that match your needs.
                        </p>
                        <div class="intro-stats">
                            <span class="stat-badge">
                                <i class="fas fa-leaf me-1"></i>
                                <span id="totalSpacesIntro">...</span> Green Spaces
                            </span>
                            <span class="stat-badge">
                                <i class="fas fa-map-pin me-1"></i>
                                <span id="totalWardsIntro">...</span> Wards
                            </span>
                        </div>
                    </div>
                    <button class="help-toggle" id="helpToggle" title="Show Help & Instructions" aria-label="Show help and instructions">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
                
                <!-- Help Panel -->
                <div class="help-panel d-none" id="helpPanel">
                    <div class="help-content">
                        <h5 class="help-title">
                            <i class="fas fa-info-circle me-2"></i>
                            How to Use This Map
                        </h5>
                        <div class="help-section">
                            <h6><i class="fas fa-search me-2"></i>Search</h6>
                            <p>Type a green space name, ward, or type to find specific locations. Use keyboard arrows to navigate results.</p>
                        </div>
                        <div class="help-section">
                            <h6><i class="fas fa-filter me-2"></i>Filters</h6>
                            <p>Use filters to narrow down results by type, location, size, facilities, or accessibility features.</p>
                        </div>
                        <div class="help-section">
                            <h6><i class="fas fa-mouse-pointer me-2"></i>Map Interaction</h6>
                            <p>Click markers for details, use zoom controls, or toggle layers. Press Ctrl+B to hide/show sidebar.</p>
                        </div>
                        <div class="help-section">
                            <h6><i class="fas fa-universal-access me-2"></i>Accessibility</h6>
                            <p>Use Tab to navigate, Enter to select, and Escape to close dialogs. High contrast mode available in settings.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Search Bar -->
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="searchInput" 
                           placeholder="Search by name, ward, or type..."
                           aria-label="Search green spaces"
                           autocomplete="off">
                    <button class="search-clear" id="searchClear" title="Clear search" aria-label="Clear search">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="search-options">
                        <button class="search-option-btn" id="searchByName" title="Search by name" aria-label="Search by name">
                            <i class="fas fa-tag"></i>
                        </button>
                        <button class="search-option-btn" id="searchByWard" title="Search by ward" aria-label="Search by ward">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                        <button class="search-option-btn" id="searchByType" title="Search by type" aria-label="Search by type">
                            <i class="fas fa-leaf"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Search Results -->
                <div class="search-results d-none" id="searchResults" role="listbox" aria-label="Search results"></div>
            </div>
            
            <!-- Sidebar Content -->
            <div class="sidebar-content">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="statSpaces">...</div>
                        <div class="stat-label">Spaces</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statArea">...</div>
                        <div class="stat-label">Area (ha)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="statWards">...</div>
                        <div class="stat-label">Wards</div>
                    </div>
                </div>
                
                <!-- Enhanced Filters Section -->
                <div class="filter-section">
                    <div class="section-header">
                        <h3 class="section-title">
                            <i class="fas fa-filter"></i> Filter Green Spaces
                        </h3>
                        <button class="help-btn" data-help="filters" title="Filter Help" aria-label="Show filter help">
                            <i class="fas fa-question-circle"></i>
                        </button>
                    </div>
                    
                    <!-- Quick Filters -->
                    <div class="quick-filters">
                        <button class="quick-filter-btn active" data-filter="all" title="Show all green spaces">
                            <i class="fas fa-globe"></i>
                            <span>All</span>
                        </button>
                        <button class="quick-filter-btn" data-filter="park" title="Show parks only">
                            <i class="fas fa-tree"></i>
                            <span>Parks</span>
                        </button>
                        <button class="quick-filter-btn" data-filter="large" title="Show large spaces (>2 hectares)">
                            <i class="fas fa-expand-arrows-alt"></i>
                            <span>Large</span>
                        </button>
                        <button class="quick-filter-btn" data-filter="accessible" title="Show wheelchair accessible spaces">
                            <i class="fas fa-wheelchair"></i>
                            <span>Accessible</span>
                        </button>
                    </div>
                    
                    <!-- Detailed Filters -->
                    <div class="detailed-filters">
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-leaf me-2"></i>Type
                                <button class="tooltip-btn" data-tooltip="Filter by green space category" aria-label="Type filter help">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </label>
                            <select class="filter-select" id="filterType" aria-label="Filter by green space type">
                                <option value="all">All Types</option>
                                <option value="park">ðŸŒ³ Park</option>
                                <option value="garden">ðŸŒº Garden</option>
                                <option value="forest">ðŸŒ² Forest</option>
                                <option value="recreational">âš½ Recreational</option>
                                <option value="golf course">ðŸŒï¸ Golf Course</option>
                                <option value="other">ðŸ“Œ Other</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-map-marker-alt me-2"></i>Ward
                                <button class="tooltip-btn" data-tooltip="Filter by administrative ward" aria-label="Ward filter help">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </label>
                            <select class="filter-select" id="filterWard" aria-label="Filter by ward">
                                <option value="all">All Wards</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-ruler-combined me-2"></i>Size Range
                                <button class="tooltip-btn" data-tooltip="Filter by minimum area in square meters" aria-label="Size filter help">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </label>
                            <div class="range-container">
                                <div class="range-header">
                                    <span>Minimum Area:</span>
                                    <span class="range-value" id="areaValue">0 mÂ²</span>
                                </div>
                                <input type="range" id="areaRange" min="0" max="50000" step="1000" value="0" aria-label="Minimum area filter">
                                <div class="range-labels">
                                    <span>0</span>
                                    <span>25k</span>
                                    <span>50k mÂ²</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-sort me-2"></i>Sort By
                                <button class="tooltip-btn" data-tooltip="Choose how to order the results" aria-label="Sort filter help">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </label>
                            <select class="filter-select" id="sortBy" aria-label="Sort green spaces by">
                                <option value="name">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="size-desc">Size (Largest First)</option>
                                <option value="size-asc">Size (Smallest First)</option>
                                <option value="ward">Ward (A-Z)</option>
                                <option value="type">Type (A-Z)</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-tools me-2"></i>Facilities
                                <button class="tooltip-btn" data-tooltip="Filter by available facilities and amenities" aria-label="Facilities filter help">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </label>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" id="hasPlayground" value="playground">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-child me-2"></i>Playground
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="hasBenches" value="benches">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-chair me-2"></i>Benches
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="hasShade" value="shade">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-tree me-2"></i>Shade Trees
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="hasParking" value="parking">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-parking me-2"></i>Parking
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="hasRestrooms" value="restrooms">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-restroom me-2"></i>Restrooms
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="hasSports" value="sports">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-futbol me-2"></i>Sports Facilities
                                </label>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">
                                <i class="fas fa-universal-access me-2"></i>Accessibility
                                <button class="tooltip-btn" data-tooltip="Filter by accessibility features" aria-label="Accessibility filter help">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </label>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" id="wheelchairAccessible" value="wheelchair">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-wheelchair me-2"></i>Wheelchair Accessible
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="publicTransport" value="transport">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-bus me-2"></i>Near Public Transport
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="pavedPaths" value="paved">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-road me-2"></i>Paved Paths
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" id="lighting" value="lighting">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-lightbulb me-2"></i>Good Lighting
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn-primary" id="applyFilters">
                        <i class="fas fa-search me-2"></i> Apply Filters
                    </button>
                    <button class="btn-secondary" id="resetFilters">
                        <i class="fas fa-redo me-2"></i> Reset
                    </button>
                </div>
                
                <!-- Legend -->
                <div class="legend-container">
                    <h3 class="section-title">
                        <i class="fas fa-key"></i> Map Legend
                    </h3>
                    <div class="legend-grid">
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #4CAF50;"></div>
                            <span class="legend-label">Parks</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #2196F3;"></div>
                            <span class="legend-label">Gardens</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #9C27B0;"></div>
                            <span class="legend-label">Forests</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #FF9800;"></div>
                            <span class="legend-label">Recreational</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #795548;"></div>
                            <span class="legend-label">Golf Courses</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background-color: #607D8B;"></div>
                            <span class="legend-label">Other</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map Container -->
        <div class="map-container">
            <!-- Toggle Sidebar Button -->
            <button class="sidebar-toggle sidebar-open" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- Map -->
            <div id="map"></div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <button class="control-btn" id="toggleSidebarBtn" title="Toggle Sidebar" aria-label="Toggle sidebar visibility">
                    <i class="fas fa-bars"></i>
                </button>
                <button class="control-btn" id="accessibilityBtn" title="Accessibility Settings" aria-label="Open accessibility settings">
                    <i class="fas fa-universal-access"></i>
                </button>
                <button class="control-btn" id="exportDataBtn" title="Export Data" aria-label="Export green spaces data">
                    <i class="fas fa-download"></i>
                </button>
                <button class="control-btn" id="analyticsBtn" title="Advanced Analytics" aria-label="View advanced analytics">
                    <i class="fas fa-chart-line"></i>
                </button>
                <button class="control-btn" id="homeBtn" title="Go to Homepage" aria-label="Go to homepage">
                    <i class="fas fa-home"></i>
                </button>
                <button class="control-btn" id="locateBtn" title="Find my location" aria-label="Find my current location">
                    <i class="fas fa-location-arrow"></i>
                </button>
                <button class="control-btn" id="fullscreenBtn" title="Toggle Fullscreen" aria-label="Toggle fullscreen mode">
                    <i class="fas fa-expand"></i>
                </button>
                <button class="control-btn" id="feedbackBtn" title="Report Issue" aria-label="Report an issue or provide feedback">
                    <i class="fas fa-flag"></i>
                </button>
                <button class="control-btn" id="dashboardBtn" title="View Dashboard" aria-label="View statistics dashboard">
                    <i class="fas fa-chart-bar"></i>
                </button>
                <button class="control-btn" id="refreshBtn" title="Refresh Data" aria-label="Refresh green spaces data">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            
            <!-- Loading Overlay -->
            <div class="loading-overlay" id="loadingOverlay">
                <div class="loading-container">
                    <div class="spinner-container">
                        <div class="spinner"></div>
                        <div class="spinner-inner"></div>
                    </div>
                    <div class="loading-content">
                        <h3 class="loading-title" id="loadingTitle">Loading Green Spaces</h3>
                        <p class="loading-text" id="loadingText">Connecting to database...</p>
                        <div class="progress-container" id="progressContainer">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="progress-text" id="progressText">0%</div>
                        </div>
                        <div class="loading-steps" id="loadingSteps">
                            <div class="step" id="step1">
                                <i class="fas fa-database"></i>
                                <span>Connecting to database</span>
                            </div>
                            <div class="step" id="step2">
                                <i class="fas fa-download"></i>
                                <span>Fetching green spaces data</span>
                            </div>
                            <div class="step" id="step3">
                                <i class="fas fa-map-marked-alt"></i>
                                <span>Rendering map markers</span>
                            </div>
                            <div class="step" id="step4">
                                <i class="fas fa-chart-bar"></i>
                                <span>Calculating statistics</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Accessibility Settings Modal -->
    <div class="modal fade" id="accessibilityModal" tabindex="-1" aria-labelledby="accessibilityModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #1565C0, #1976D2); color: white;">
                    <h5 class="modal-title" id="accessibilityModalLabel">
                        <i class="fas fa-universal-access me-2"></i>Accessibility Settings
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-eye me-2"></i>Visual Settings</h6>
                                </div>
                                <div class="card-body">
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="highContrastMode" class="setting-checkbox">
                                            <span class="setting-text">High Contrast Mode</span>
                                            <small class="setting-description">Increases contrast for better visibility</small>
                                        </label>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="largeText" class="setting-checkbox">
                                            <span class="setting-text">Large Text</span>
                                            <small class="setting-description">Increases font size throughout the interface</small>
                                        </label>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="reducedMotion" class="setting-checkbox">
                                            <span class="setting-text">Reduce Motion</span>
                                            <small class="setting-description">Minimizes animations and transitions</small>
                                        </label>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="colorBlindMode" class="setting-checkbox">
                                            <span class="setting-text">Color Blind Friendly</span>
                                            <small class="setting-description">Uses patterns and shapes in addition to colors</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-keyboard me-2"></i>Navigation Settings</h6>
                                </div>
                                <div class="card-body">
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="keyboardNavigation" class="setting-checkbox" checked>
                                            <span class="setting-text">Enhanced Keyboard Navigation</span>
                                            <small class="setting-description">Improved Tab and arrow key navigation</small>
                                        </label>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="focusIndicators" class="setting-checkbox" checked>
                                            <span class="setting-text">Enhanced Focus Indicators</span>
                                            <small class="setting-description">More visible focus outlines</small>
                                        </label>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="skipLinks" class="setting-checkbox">
                                            <span class="setting-text">Skip Navigation Links</span>
                                            <small class="setting-description">Adds skip-to-content links</small>
                                        </label>
                                    </div>
                                    <div class="setting-item">
                                        <label class="setting-label">
                                            <input type="checkbox" id="screenReaderMode" class="setting-checkbox">
                                            <span class="setting-text">Screen Reader Optimized</span>
                                            <small class="setting-description">Enhanced descriptions and ARIA labels</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-keyboard me-2"></i>Keyboard Shortcuts</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="shortcut-item">
                                                <kbd>Ctrl + B</kbd>
                                                <span>Toggle Sidebar</span>
                                            </div>
                                            <div class="shortcut-item">
                                                <kbd>Ctrl + F</kbd>
                                                <span>Focus Search</span>
                                            </div>
                                            <div class="shortcut-item">
                                                <kbd>Ctrl + H</kbd>
                                                <span>Show/Hide Help</span>
                                            </div>
                                            <div class="shortcut-item">
                                                <kbd>Escape</kbd>
                                                <span>Close Dialogs</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="shortcut-item">
                                                <kbd>Arrow Keys</kbd>
                                                <span>Navigate Search Results</span>
                                            </div>
                                            <div class="shortcut-item">
                                                <kbd>Enter</kbd>
                                                <span>Select/Activate</span>
                                            </div>
                                            <div class="shortcut-item">
                                                <kbd>Tab</kbd>
                                                <span>Navigate Elements</span>
                                            </div>
                                            <div class="shortcut-item">
                                                <kbd>Space</kbd>
                                                <span>Toggle Checkboxes</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveAccessibilitySettings()">
                        <i class="fas fa-save me-2"></i>Save Settings
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="resetAccessibilitySettings()">
                        <i class="fas fa-undo me-2"></i>Reset to Default
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Analytics Modal -->
    <div class="modal fade" id="analyticsModal" tabindex="-1" aria-labelledby="analyticsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #1565C0, #1976D2); color: white;">
                    <h5 class="modal-title" id="analyticsModalLabel">
                        <i class="fas fa-chart-line me-2"></i>Advanced Spatial Analytics
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="analyticsModalBody">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Green Space Distribution</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="distributionChart" width="400" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Area Coverage by Ward</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="wardChart" width="400" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card mb-3">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-leaf me-2"></i>Environmental Impact Analysis</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="environmentalMetrics">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Urban Planning Recommendations</h6>
                                </div>
                                <div class="card-body" id="recommendations">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="exportAnalytics()">
                        <i class="fas fa-download me-2"></i>Export Report
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailed Information Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;">
                    <h5 class="modal-title" id="detailModalLabel">
                        <i class="fas fa-tree me-2"></i>Green Space Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailModalBody">
                    <!-- Content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="window.location.href='feedback.html'" style="background: var(--primary-color); border-color: var(--primary-color);">
                        <i class="fas fa-flag me-2"></i>Report Issue
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- External JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.fullscreen/2.0.0/Control.FullScreen.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Configuration -->
    <script src="config.js"></script>
    
    <!-- Fallback Data -->
    <script src="fallback-data.js"></script>
    
    <!-- Main Application Script -->
    <script>
        console.log('ðŸš€ Kitwe Green Space Map - Professional Version');
        
        // Global variables
        let map;
        let allMarkers = [];
        let allGreenSpaces = [];
        let layerGroups = {};
        let loadingManager = null;
        let networkStatus = 'online';
        let retryAttempts = 0;
        const maxRetryAttempts = 3;
        
        // Loading Manager Class
        class LoadingManager {
            constructor() {
                this.overlay = document.getElementById('loadingOverlay');
                this.title = document.getElementById('loadingTitle');
                this.text = document.getElementById('loadingText');
                this.progressFill = document.getElementById('progressFill');
                this.progressText = document.getElementById('progressText');
                this.steps = {
                    step1: document.getElementById('step1'),
                    step2: document.getElementById('step2'),
                    step3: document.getElementById('step3'),
                    step4: document.getElementById('step4')
                };
                this.currentStep = 0;
                this.progress = 0;
            }
            
            show(title = 'Loading', text = 'Please wait...') {
                this.title.textContent = title;
                this.text.textContent = text;
                this.overlay.style.display = 'flex';
                this.setProgress(0);
                this.setStep(0);
            }
            
            hide() {
                this.overlay.style.display = 'none';
                this.setProgress(0);
                this.setStep(0);
            }
            
            setProgress(percent) {
                this.progress = Math.max(0, Math.min(100, percent));
                this.progressFill.style.width = this.progress + '%';
                this.progressText.textContent = Math.round(this.progress) + '%';
            }
            
            setStep(stepNumber) {
                // Reset all steps
                Object.values(this.steps).forEach(step => {
                    step.classList.remove('active', 'completed');
                });
                
                // Mark completed steps
                for (let i = 1; i < stepNumber; i++) {
                    if (this.steps[`step${i}`]) {
                        this.steps[`step${i}`].classList.add('completed');
                    }
                }
                
                // Mark current step as active
                if (stepNumber > 0 && this.steps[`step${stepNumber}`]) {
                    this.steps[`step${stepNumber}`].classList.add('active');
                }
                
                this.currentStep = stepNumber;
            }
            
            updateText(text) {
                this.text.textContent = text;
            }
            
            updateTitle(title) {
                this.title.textContent = title;
            }
        }
        
        // Network Status Manager
        class NetworkStatusManager {
            constructor() {
                this.indicator = document.getElementById('networkStatus');
                this.text = document.getElementById('networkStatusText');
                this.status = 'online';
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                window.addEventListener('online', () => this.setStatus('online'));
                window.addEventListener('offline', () => this.setStatus('offline'));
            }
            
            setStatus(status, message = null) {
                this.status = status;
                this.indicator.className = `network-status ${status}`;
                
                const messages = {
                    online: 'Connected',
                    offline: 'No Internet Connection',
                    reconnecting: 'Reconnecting...'
                };
                
                const icons = {
                    online: 'fa-wifi',
                    offline: 'fa-wifi-slash',
                    reconnecting: 'fa-sync fa-spin'
                };
                
                this.text.textContent = message || messages[status];
                this.indicator.querySelector('i').className = `fas ${icons[status]}`;
                
                // Show indicator for offline/reconnecting states
                if (status !== 'online') {
                    this.show();
                    setTimeout(() => this.hide(), 5000); // Auto-hide after 5 seconds
                } else {
                    this.show();
                    setTimeout(() => this.hide(), 2000); // Show briefly for online status
                }
            }
            
            show() {
                this.indicator.classList.add('show');
            }
            
            hide() {
                this.indicator.classList.remove('show');
            }
        }
        
        // Error Handler Class
        class ErrorHandler {
            static show(title, message, actions = []) {
                // Remove existing error overlay
                const existingError = document.querySelector('.error-overlay');
                if (existingError) {
                    existingError.remove();
                }
                
                const errorOverlay = document.createElement('div');
                errorOverlay.className = 'error-overlay';
                
                const actionsHtml = actions.map(action => 
                    `<button class="error-btn ${action.type || 'error-btn-primary'}" onclick="${action.onclick}">
                        <i class="fas ${action.icon} me-2"></i>${action.text}
                    </button>`
                ).join('');
                
                errorOverlay.innerHTML = `
                    <div class="error-container">
                        <div class="error-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 class="error-title">${title}</h3>
                        <p class="error-message">${message}</p>
                        <div class="error-actions">
                            ${actionsHtml}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(errorOverlay);
                
                // Auto-remove after 30 seconds if no user interaction
                setTimeout(() => {
                    if (document.body.contains(errorOverlay)) {
                        errorOverlay.remove();
                    }
                }, 30000);
            }
            
            static hide() {
                const errorOverlay = document.querySelector('.error-overlay');
                if (errorOverlay) {
                    errorOverlay.remove();
                }
            }
        }
        
        // Button Loading State Manager
        class ButtonLoader {
            static setLoading(button, loading = true) {
                if (loading) {
                    button.classList.add('btn-loading');
                    const text = button.querySelector('.btn-text') || button;
                    if (!button.querySelector('.btn-text')) {
                        button.innerHTML = `<span class="btn-text">${button.innerHTML}</span>`;
                    }
                } else {
                    button.classList.remove('btn-loading');
                }
            }
        }
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ“± DOM loaded, initializing professional map...');
            
            // Initialize managers
            loadingManager = new LoadingManager();
            const networkManager = new NetworkStatusManager();
            
            // Show initial loading
            loadingManager.show('Initializing GIS System', 'Setting up map components...');
            
            // Initialize everything in the correct order with progress tracking
            setTimeout(() => {
                initializeMap();
                setupSidebar();
                setupControls();
                setupAccessibility();
                setupEnhancedFilters();
                loadGreenSpaces();
            }, 500); // Small delay to show loading state
        });
        
        // Setup enhanced accessibility features
        function setupAccessibility() {
            console.log('â™¿ Setting up accessibility features...');
            
            // Load saved accessibility settings
            loadAccessibilitySettings();
            
            // Setup keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl + B: Toggle sidebar
                if (e.ctrlKey && e.key === 'b') {
                    e.preventDefault();
                    document.getElementById('sidebarToggle').click();
                }
                
                // Ctrl + F: Focus search
                if (e.ctrlKey && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                }
                
                // Ctrl + H: Toggle help
                if (e.ctrlKey && e.key === 'h') {
                    e.preventDefault();
                    document.getElementById('helpToggle').click();
                }
                
                // Escape: Close modals and dialogs
                if (e.key === 'Escape') {
                    const openModal = document.querySelector('.modal.show');
                    if (openModal) {
                        bootstrap.Modal.getInstance(openModal).hide();
                    }
                    
                    const helpPanel = document.getElementById('helpPanel');
                    if (!helpPanel.classList.contains('d-none')) {
                        helpPanel.classList.add('d-none');
                    }
                    
                    const searchResults = document.getElementById('searchResults');
                    if (!searchResults.classList.contains('d-none')) {
                        searchResults.classList.add('d-none');
                    }
                }
            });
            
            // Setup accessibility button
            const accessibilityBtn = document.getElementById('accessibilityBtn');
            if (accessibilityBtn) {
                accessibilityBtn.addEventListener('click', function() {
                    const modal = new bootstrap.Modal(document.getElementById('accessibilityModal'));
                    modal.show();
                });
            }
            
            // Setup help toggle
            const helpToggle = document.getElementById('helpToggle');
            const helpPanel = document.getElementById('helpPanel');
            if (helpToggle && helpPanel) {
                helpToggle.addEventListener('click', function() {
                    helpPanel.classList.toggle('d-none');
                    const isVisible = !helpPanel.classList.contains('d-none');
                    helpToggle.setAttribute('title', isVisible ? 'Hide Help' : 'Show Help & Instructions');
                    helpToggle.setAttribute('aria-expanded', isVisible);
                });
            }
            
            // Setup tooltips
            setupTooltips();
            
            console.log('âœ… Accessibility features setup complete');
        }
        
        // Setup enhanced filters
        function setupEnhancedFilters() {
            console.log('ðŸ” Setting up enhanced filters...');
            
            // Quick filters
            const quickFilterBtns = document.querySelectorAll('.quick-filter-btn');
            quickFilterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    quickFilterBtns.forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Apply quick filter
                    const filterType = this.dataset.filter;
                    applyQuickFilter(filterType);
                });
            });
            
            // Enhanced search options
            const searchOptionBtns = document.querySelectorAll('.search-option-btn');
            searchOptionBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    searchOptionBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const searchInput = document.getElementById('searchInput');
                    const searchType = this.id.replace('searchBy', '').toLowerCase();
                    
                    const placeholders = {
                        name: 'Search by green space name...',
                        ward: 'Search by ward name...',
                        type: 'Search by type (park, garden, forest)...'
                    };
                    
                    searchInput.placeholder = placeholders[searchType] || 'Search green spaces...';
                    searchInput.focus();
                });
            });
            
            // Sort functionality
            const sortSelect = document.getElementById('sortBy');
            if (sortSelect) {
                sortSelect.addEventListener('change', function() {
                    applySortAndFilter();
                });
            }
            
            // Facility checkboxes
            const facilityCheckboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]');
            facilityCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    applySortAndFilter();
                });
            });
            
            console.log('âœ… Enhanced filters setup complete');
        }
        
        // Apply quick filters
        function applyQuickFilter(filterType) {
            let filtered = [...allGreenSpaces];
            
            switch(filterType) {
                case 'all':
                    // Show all spaces
                    break;
                case 'park':
                    filtered = filtered.filter(space => space.properties.type === 'park');
                    break;
                case 'large':
                    filtered = filtered.filter(space => (space.properties.area_sq_m || 0) > 20000);
                    break;
                case 'accessible':
                    // For demo purposes, assume parks and recreational areas are more accessible
                    filtered = filtered.filter(space => 
                        ['park', 'recreational'].includes(space.properties.type)
                    );
                    break;
            }
            
            displayGreenSpaces(filtered);
            updateStatistics(filtered);
            
            const filterName = filterType === 'all' ? 'all green spaces' : 
                              filterType === 'large' ? 'large green spaces (>2 hectares)' :
                              filterType === 'accessible' ? 'accessible green spaces' :
                              `${filterType}s`;
            
            showNotification(`ðŸ” Showing ${filtered.length} ${filterName}`, 'info');
        }
        
        // Enhanced sort and filter function
        function applySortAndFilter() {
            const btn = document.getElementById('applyFilters');
            if (btn) ButtonLoader.setLoading(btn, true);
            
            try {
                let filtered = [...allGreenSpaces];
                
                // Apply type filter
                const typeFilter = document.getElementById('filterType').value;
                if (typeFilter !== 'all') {
                    filtered = filtered.filter(space => space.properties.type === typeFilter);
                }
                
                // Apply ward filter
                const wardFilter = document.getElementById('filterWard').value;
                if (wardFilter !== 'all') {
                    filtered = filtered.filter(space => space.properties.ward === wardFilter);
                }
                
                // Apply area filter
                const areaFilter = parseInt(document.getElementById('areaRange').value);
                if (areaFilter > 0) {
                    filtered = filtered.filter(space => (space.properties.area_sq_m || 0) >= areaFilter);
                }
                
                // Apply facility filters
                const facilityFilters = [];
                const facilityCheckboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked');
                facilityCheckboxes.forEach(checkbox => {
                    facilityFilters.push(checkbox.value);
                });
                
                if (facilityFilters.length > 0) {
                    filtered = filtered.filter(space => {
                        // For demo purposes, apply some logic based on space type and size
                        const props = space.properties;
                        const hasPlayground = props.type === 'park' && (props.area_sq_m || 0) > 10000;
                        const hasBenches = ['park', 'garden'].includes(props.type);
                        const hasShade = ['park', 'forest', 'garden'].includes(props.type);
                        const hasParking = (props.area_sq_m || 0) > 25000;
                        const hasRestrooms = (props.area_sq_m || 0) > 20000;
                        const hasSports = props.type === 'recreational';
                        const wheelchairAccessible = ['park', 'recreational'].includes(props.type);
                        const publicTransport = true; // Assume all are near transport
                        const pavedPaths = ['park', 'recreational'].includes(props.type);
                        const lighting = (props.area_sq_m || 0) > 15000;
                        
                        const facilities = {
                            playground: hasPlayground,
                            benches: hasBenches,
                            shade: hasShade,
                            parking: hasParking,
                            restrooms: hasRestrooms,
                            sports: hasSports,
                            wheelchair: wheelchairAccessible,
                            transport: publicTransport,
                            paved: pavedPaths,
                            lighting: lighting
                        };
                        
                        return facilityFilters.every(filter => facilities[filter]);
                    });
                }
                
                // Apply sorting
                const sortBy = document.getElementById('sortBy').value;
                filtered.sort((a, b) => {
                    const propsA = a.properties;
                    const propsB = b.properties;
                    
                    switch(sortBy) {
                        case 'name':
                            return propsA.name.localeCompare(propsB.name);
                        case 'name-desc':
                            return propsB.name.localeCompare(propsA.name);
                        case 'size-desc':
                            return (propsB.area_sq_m || 0) - (propsA.area_sq_m || 0);
                        case 'size-asc':
                            return (propsA.area_sq_m || 0) - (propsB.area_sq_m || 0);
                        case 'ward':
                            return (propsA.ward || '').localeCompare(propsB.ward || '');
                        case 'type':
                            return propsA.type.localeCompare(propsB.type);
                        default:
                            return 0;
                    }
                });
                
                setTimeout(() => {
                    displayGreenSpaces(filtered);
                    updateStatistics(filtered);
                    
                    if (btn) ButtonLoader.setLoading(btn, false);
                    showNotification(`âœ… Showing ${filtered.length} filtered and sorted green spaces`, 'success');
                }, 300);
                
            } catch (error) {
                if (btn) ButtonLoader.setLoading(btn, false);
                showNotification(`âŒ Filter error: ${error.message}`, 'error');
            }
        }
        
        // Initialize the map
        function initializeMap() {
            console.log('ðŸ—ºï¸ Initializing map...');
            
            try {
                // Create map
                map = L.map('map', {
                    center: [-12.8130, 28.2200],
                    zoom: 13,
                    zoomControl: false
                });
                
                // Add zoom control to top-left
                L.control.zoom({
                    position: 'topleft'
                }).addTo(map);
                
                // Multiple tile layers
                const osmStandard = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: 'Â© OpenStreetMap contributors'
                });
                
                const cartoDB = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    maxZoom: 19,
                    attribution: 'Â© OpenStreetMap contributors Â© CARTO'
                });
                
                // Add default layer
                osmStandard.addTo(map);
                
                // Create layer groups
                layerGroups = {
                    park: L.layerGroup(),
                    garden: L.layerGroup(),
                    forest: L.layerGroup(),
                    recreational: L.layerGroup(),
                    'golf course': L.layerGroup(),
                    other: L.layerGroup()
                };
                
                // Add layer groups to map
                Object.values(layerGroups).forEach(layer => layer.addTo(map));
                
                // Layer control
                const baseMaps = {
                    "Standard": osmStandard,
                    "Light Theme": cartoDB
                };
                
                const overlayMaps = {
                    "Parks": layerGroups.park,
                    "Gardens": layerGroups.garden,
                    "Forests": layerGroups.forest,
                    "Recreational": layerGroups.recreational,
                    "Golf Courses": layerGroups['golf course'],
                    "Other": layerGroups.other
                };
                
                L.control.layers(baseMaps, overlayMaps, {
                    position: 'topright',
                    collapsed: true
                }).addTo(map);
                
                console.log('âœ… Map initialized successfully');
                
            } catch (error) {
                console.error('âŒ Map initialization failed:', error);
                showError('Failed to initialize map: ' + error.message);
            }
        }
        
        // Setup sidebar functionality
        function setupSidebar() {
            console.log('ðŸŽ›ï¸ Setting up sidebar...');
            
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');
            
            if (sidebarToggle && sidebar) {
                // Set initial state
                sidebarToggle.setAttribute('data-tooltip', 'Hide Sidebar');
                
                const toggleSidebar = function() {
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    const mapContainer = document.querySelector('.map-container');
                    
                    if (isCollapsed) {
                        // Show sidebar
                        sidebar.classList.remove('collapsed');
                        mapContainer.classList.remove('sidebar-hidden');
                        sidebarToggle.classList.add('sidebar-open');
                        sidebarToggle.classList.remove('sidebar-closed');
                        sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
                        sidebarToggle.setAttribute('data-tooltip', 'Hide Sidebar');
                        
                        showNotification('Sidebar shown', 'info');
                    } else {
                        // Hide sidebar
                        sidebar.classList.add('collapsed');
                        mapContainer.classList.add('sidebar-hidden');
                        sidebarToggle.classList.remove('sidebar-open');
                        sidebarToggle.classList.add('sidebar-closed');
                        sidebarToggle.innerHTML = '<i class="fas fa-chevron-right"></i>';
                        sidebarToggle.setAttribute('data-tooltip', 'Show Sidebar');
                        
                        showNotification('Sidebar hidden - full map view!', 'info');
                    }
                    
                    // Trigger map resize after animation
                    setTimeout(() => {
                        if (map) {
                            map.invalidateSize();
                        }
                    }, 300);
                };
                
                sidebarToggle.addEventListener('click', toggleSidebar);
                
                // Add close button functionality (for mobile)
                if (sidebarCloseBtn) {
                    sidebarCloseBtn.addEventListener('click', function() {
                        if (!sidebar.classList.contains('collapsed')) {
                            toggleSidebar();
                        }
                    });
                }
                
                // Add keyboard shortcut (Ctrl + B)
                document.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'b') {
                        e.preventDefault();
                        toggleSidebar();
                    }
                });
            }
            
            // Setup search
            setupSearch();
            
            // Setup filters
            setupFilters();
            
            console.log('âœ… Sidebar setup complete');
        }
        
        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');
            const searchResults = document.getElementById('searchResults');
            
            if (!searchInput || !searchClear || !searchResults) {
                console.error('âŒ Search elements not found');
                return;
            }
            
            let searchTimeout;
            let selectedIndex = -1;
            
            // Enhanced search with debouncing and keyboard navigation
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                selectedIndex = -1;
                searchTimeout = setTimeout(performSearch, 150); // Faster debounce for better UX
            });
            
            searchInput.addEventListener('keydown', (e) => {
                const results = searchResults.querySelectorAll('.search-result-item:not(.no-results)');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, results.length - 1);
                    updateSelection(results);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection(results);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedIndex >= 0 && results[selectedIndex]) {
                        results[selectedIndex].click();
                    } else if (results.length > 0) {
                        results[0].click();
                    }
                } else if (e.key === 'Escape') {
                    clearSearch();
                }
            });
            
            searchClear.addEventListener('click', clearSearch);
            
            // Close search results when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.add('d-none');
                }
            });
            
            function updateSelection(results) {
                results.forEach((result, index) => {
                    result.classList.toggle('highlighted', index === selectedIndex);
                });
            }
            
            function performSearch() {
                const query = searchInput.value.toLowerCase().trim();
                searchResults.innerHTML = '';
                selectedIndex = -1;
                
                if (!query) {
                    searchResults.classList.add('d-none');
                    return;
                }
                
                if (!allGreenSpaces || allGreenSpaces.length === 0) {
                    searchResults.innerHTML = '<div class="search-result-item no-results">Loading data...</div>';
                    searchResults.classList.remove('d-none');
                    return;
                }
                
                // Enhanced search - match name, ward, type, and description with scoring
                const results = allGreenSpaces.map(space => {
                    const props = space.properties;
                    let score = 0;
                    let matchType = '';
                    
                    // Exact name match (highest priority)
                    if (props.name.toLowerCase() === query) {
                        score = 100;
                        matchType = 'exact';
                    }
                    // Name starts with query
                    else if (props.name.toLowerCase().startsWith(query)) {
                        score = 90;
                        matchType = 'name_start';
                    }
                    // Name contains query
                    else if (props.name.toLowerCase().includes(query)) {
                        score = 80;
                        matchType = 'name_contains';
                    }
                    // Ward match
                    else if (props.ward && props.ward.toLowerCase().includes(query)) {
                        score = 70;
                        matchType = 'ward';
                    }
                    // Type match
                    else if (props.type.toLowerCase().includes(query)) {
                        score = 60;
                        matchType = 'type';
                    }
                    // Description match
                    else if (props.description && props.description.toLowerCase().includes(query)) {
                        score = 50;
                        matchType = 'description';
                    }
                    
                    return score > 0 ? { space, score, matchType } : null;
                }).filter(Boolean).sort((a, b) => b.score - a.score);
                
                if (results.length > 0) {
                    searchResults.classList.remove('d-none');
                    
                    // Show top 8 results with better formatting
                    results.slice(0, 8).forEach((result, index) => {
                        const { space, matchType } = result;
                        const props = space.properties;
                        const resultItem = document.createElement('div');
                        resultItem.className = 'search-result-item';
                        if (index === 0) resultItem.classList.add('highlighted');
                        
                        // Highlight matching text
                        let displayName = props.name;
                        let displayWard = props.ward || 'N/A';
                        let displayType = props.type;
                        
                        const regex = new RegExp(`(${query})`, 'gi');
                        if (matchType.includes('name')) {
                            displayName = displayName.replace(regex, '<mark>$1</mark>');
                        } else if (matchType === 'ward') {
                            displayWard = displayWard.replace(regex, '<mark>$1</mark>');
                        } else if (matchType === 'type') {
                            displayType = displayType.replace(regex, '<mark>$1</mark>');
                        }
                        
                        resultItem.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; margin-bottom: 2px;">${displayName}</div>
                                    <div style="font-size: 12px; color: #666; display: flex; gap: 8px;">
                                        <span>${displayType}</span>
                                        <span>â€¢</span>
                                        <span>${displayWard}</span>
                                        <span>â€¢</span>
                                        <span>${props.area_hectares ? parseFloat(props.area_hectares).toFixed(1) : 
                                               props.area_sq_m ? (props.area_sq_m / 10000).toFixed(1) : '1.5'} ha</span>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; color: var(--primary-color);">
                                    <i class="fas fa-search" style="font-size: 12px;"></i>
                                    <i class="fas fa-map-marker-alt"></i>
                                </div>
                            </div>
                        `;
                        
                        resultItem.addEventListener('click', () => {
                            selectGreenSpace(space);
                        });
                        
                        // Add hover effects
                        resultItem.addEventListener('mouseenter', () => {
                            selectedIndex = index;
                            updateSelection(searchResults.querySelectorAll('.search-result-item:not(.no-results)'));
                        });
                        
                        searchResults.appendChild(resultItem);
                    });
                    
                    if (results.length > 8) {
                        const moreItem = document.createElement('div');
                        moreItem.className = 'search-result-item no-results';
                        moreItem.style.cssText = 'color: #999; font-style: italic; text-align: center; padding: 8px;';
                        moreItem.innerHTML = `<small><i class="fas fa-ellipsis-h me-2"></i>+${results.length - 8} more results... (refine search)</small>`;
                        searchResults.appendChild(moreItem);
                    }
                } else {
                    searchResults.innerHTML = `
                        <div class="search-result-item no-results" style="color: #999; text-align: center;">
                            <i class="fas fa-search me-2"></i>No results found for "${query}"
                            <div style="font-size: 11px; margin-top: 4px;">Try searching by name, ward, or type</div>
                        </div>
                    `;
                    searchResults.classList.remove('d-none');
                }
            }
            
            function selectGreenSpace(space) {
                const coords = space.geometry.coordinates;
                const props = space.properties;
                
                // Smooth zoom to the location with enhanced animation
                map.flyTo([coords[1], coords[0]], 17, {
                    animate: true,
                    duration: 2.0, // Slightly longer for smoother effect
                    easeLinearity: 0.1
                });
                
                // Find and open the marker popup with delay for smooth experience
                setTimeout(() => {
                    let markerFound = false;
                    allMarkers.forEach(marker => {
                        const markerLatLng = marker.getLatLng();
                        if (Math.abs(markerLatLng.lat - coords[1]) < 0.0001 && 
                            Math.abs(markerLatLng.lng - coords[0]) < 0.0001) {
                            marker.openPopup();
                            markerFound = true;
                            
                            // Add a subtle bounce effect to the marker
                            const markerElement = marker.getElement();
                            if (markerElement) {
                                markerElement.style.animation = 'bounce 0.6s ease-in-out';
                                setTimeout(() => {
                                    markerElement.style.animation = '';
                                }, 600);
                            }
                        }
                    });
                    
                    if (markerFound) {
                        showNotification(`ðŸ“ Found: ${props.name} in ${props.ward || 'Kitwe'}`, 'success');
                    }
                }, 2100); // Wait for zoom animation to complete
                
                // Update search input and clear results
                searchInput.value = props.name;
                searchResults.innerHTML = '';
                searchResults.classList.add('d-none');
                
                // Blur the search input to hide mobile keyboard
                searchInput.blur();
            }
            
            function clearSearch() {
                searchInput.value = '';
                searchResults.innerHTML = '';
                searchResults.classList.add('d-none');
                selectedIndex = -1;
                searchInput.focus();
            }
        }
        
        // Setup filters
        function setupFilters() {
            const applyBtn = document.getElementById('applyFilters');
            const resetBtn = document.getElementById('resetFilters');
            const areaRange = document.getElementById('areaRange');
            const areaValue = document.getElementById('areaValue');
            
            if (applyBtn) applyBtn.addEventListener('click', applyFilters);
            if (resetBtn) resetBtn.addEventListener('click', resetFilters);
            
            if (areaRange && areaValue) {
                areaRange.addEventListener('input', function() {
                    const value = parseInt(this.value);
                    areaValue.textContent = value.toLocaleString() + ' mÂ²';
                });
            }
        }
        
        // Setup control buttons
        function setupControls() {
            console.log('ðŸŽ® Setting up controls...');
            
            const controls = {
                toggleSidebarBtn: () => document.getElementById('sidebarToggle').click(),
                exportDataBtn: exportData,
                analyticsBtn: showAdvancedAnalytics,
                homeBtn: () => window.location.href = 'home.html',
                locateBtn: findUserLocation,
                fullscreenBtn: toggleFullscreen,
                feedbackBtn: () => window.location.href = 'feedback.html',
                dashboardBtn: () => window.location.href = 'simpledashboard.html',
                refreshBtn: refreshData
            };
            
            Object.entries(controls).forEach(([id, handler]) => {
                const btn = document.getElementById(id);
                if (btn) btn.addEventListener('click', handler);
            });
        }
        
        // Load green spaces data with enhanced loading and error handling
        async function loadGreenSpaces() {
            console.log('ðŸ“Š Loading green spaces data from live backend...');
            
            try {
                // Step 1: Connecting to database
                loadingManager.setStep(1);
                loadingManager.updateTitle('Loading Green Spaces Data');
                loadingManager.updateText('Connecting to database...');
                loadingManager.setProgress(10);
                
                // Check network connectivity first
                if (!navigator.onLine) {
                    throw new Error('NETWORK_OFFLINE');
                }
                
                // Try live API with enhanced timeout and retry logic
                const timestamp = new Date().getTime();
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); // Increased timeout
                
                loadingManager.setProgress(25);
                loadingManager.updateText('Fetching data from server...');
                
                const response = await fetch(`${window.APP_CONFIG.API_BASE_URL}/api/green-spaces?t=${timestamp}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache',
                        'Accept': 'application/json'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                // Step 2: Processing response
                loadingManager.setStep(2);
                loadingManager.setProgress(50);
                loadingManager.updateText('Processing server response...');
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('API_NOT_FOUND');
                    } else if (response.status >= 500) {
                        throw new Error('SERVER_ERROR');
                    } else if (response.status === 429) {
                        throw new Error('RATE_LIMITED');
                    } else {
                        throw new Error(`HTTP_ERROR_${response.status}`);
                    }
                }
                
                const data = await response.json();
                
                if (!data || !data.features || !Array.isArray(data.features)) {
                    throw new Error('INVALID_DATA_FORMAT');
                }
                
                allGreenSpaces = data.features;
                loadingManager.setProgress(70);
                
                console.log(`âœ… Loaded ${allGreenSpaces.length} green spaces from live database`);
                
                // Step 3: Rendering map markers
                loadingManager.setStep(3);
                loadingManager.updateText('Rendering map markers...');
                loadingManager.setProgress(80);
                
                await new Promise(resolve => setTimeout(resolve, 300)); // Allow UI update
                displayGreenSpaces(allGreenSpaces);
                
                // Step 4: Calculating statistics
                loadingManager.setStep(4);
                loadingManager.updateText('Calculating statistics...');
                loadingManager.setProgress(90);
                
                await new Promise(resolve => setTimeout(resolve, 200)); // Allow UI update
                updateStatistics(allGreenSpaces);
                populateWardFilter(allGreenSpaces);
                
                loadingManager.setProgress(100);
                loadingManager.updateText('Complete!');
                
                // Success notification
                setTimeout(() => {
                    loadingManager.hide();
                    showNotification(`âœ… Successfully loaded ${allGreenSpaces.length} green spaces from live database`, 'success');
                    retryAttempts = 0; // Reset retry counter on success
                }, 500);
                
            } catch (error) {
                console.log('âš ï¸ Error loading from live API:', error.message);
                
                // Handle specific error types
                await handleLoadingError(error);
            }
        }
        
        // Enhanced error handling for data loading
        async function handleLoadingError(error) {
            const errorType = error.message || error.name || 'UNKNOWN_ERROR';
            
            // Hide loading overlay
            loadingManager.hide();
            
            switch (errorType) {
                case 'NETWORK_OFFLINE':
                    await handleOfflineError();
                    break;
                    
                case 'AbortError':
                case 'TIMEOUT':
                    await handleTimeoutError();
                    break;
                    
                case 'API_NOT_FOUND':
                    await handleApiNotFoundError();
                    break;
                    
                case 'SERVER_ERROR':
                    await handleServerError();
                    break;
                    
                case 'RATE_LIMITED':
                    await handleRateLimitError();
                    break;
                    
                case 'INVALID_DATA_FORMAT':
                    await handleInvalidDataError();
                    break;
                    
                default:
                    await handleGenericError(error);
            }
        }
        
        // Specific error handlers
        async function handleOfflineError() {
            if (await tryFallbackData()) {
                showNotification('ðŸ“± You\'re offline. Using cached data.', 'info');
            } else {
                ErrorHandler.show(
                    'No Internet Connection',
                    'Please check your internet connection and try again. The app needs an internet connection to load green spaces data.',
                    [
                        {
                            text: 'Try Again',
                            icon: 'fa-redo',
                            onclick: 'retryDataLoad()',
                            type: 'error-btn-primary'
                        },
                        {
                            text: 'Use Demo Data',
                            icon: 'fa-database',
                            onclick: 'loadDemoData()',
                            type: 'error-btn-secondary'
                        }
                    ]
                );
            }
        }
        
        async function handleTimeoutError() {
            if (retryAttempts < maxRetryAttempts) {
                retryAttempts++;
                showNotification(`â±ï¸ Connection timeout. Retrying... (${retryAttempts}/${maxRetryAttempts})`, 'warning');
                setTimeout(() => loadGreenSpaces(), 2000);
            } else {
                if (await tryFallbackData()) {
                    showNotification('âš ï¸ Server is slow. Using cached data.', 'warning');
                } else {
                    ErrorHandler.show(
                        'Connection Timeout',
                        'The server is taking too long to respond. This might be due to a slow internet connection or server issues.',
                        [
                            {
                                text: 'Try Again',
                                icon: 'fa-redo',
                                onclick: 'retryDataLoad()',
                                type: 'error-btn-primary'
                            },
                            {
                                text: 'Use Demo Data',
                                icon: 'fa-database',
                                onclick: 'loadDemoData()',
                                type: 'error-btn-secondary'
                            }
                        ]
                    );
                }
            }
        }
        
        async function handleApiNotFoundError() {
            if (await tryFallbackData()) {
                showNotification('ðŸ”§ API endpoint not found. Using cached data.', 'warning');
            } else {
                ErrorHandler.show(
                    'Service Unavailable',
                    'The green spaces data service is currently unavailable. This might be due to maintenance or configuration issues.',
                    [
                        {
                            text: 'Try Again Later',
                            icon: 'fa-clock',
                            onclick: 'retryDataLoad()',
                            type: 'error-btn-primary'
                        },
                        {
                            text: 'Use Demo Data',
                            icon: 'fa-database',
                            onclick: 'loadDemoData()',
                            type: 'error-btn-secondary'
                        }
                    ]
                );
            }
        }
        
        async function handleServerError() {
            if (await tryFallbackData()) {
                showNotification('ðŸ”§ Server error. Using cached data.', 'warning');
            } else {
                ErrorHandler.show(
                    'Server Error',
                    'The server encountered an error while processing your request. Our team has been notified and is working on a fix.',
                    [
                        {
                            text: 'Try Again',
                            icon: 'fa-redo',
                            onclick: 'retryDataLoad()',
                            type: 'error-btn-primary'
                        },
                        {
                            text: 'Use Demo Data',
                            icon: 'fa-database',
                            onclick: 'loadDemoData()',
                            type: 'error-btn-secondary'
                        }
                    ]
                );
            }
        }
        
        async function handleRateLimitError() {
            showNotification('â³ Too many requests. Please wait a moment...', 'warning');
            setTimeout(() => loadGreenSpaces(), 5000); // Retry after 5 seconds
        }
        
        async function handleInvalidDataError() {
            if (await tryFallbackData()) {
                showNotification('âš ï¸ Invalid data received. Using cached data.', 'warning');
            } else {
                ErrorHandler.show(
                    'Data Format Error',
                    'The server returned data in an unexpected format. This might be a temporary issue.',
                    [
                        {
                            text: 'Try Again',
                            icon: 'fa-redo',
                            onclick: 'retryDataLoad()',
                            type: 'error-btn-primary'
                        },
                        {
                            text: 'Use Demo Data',
                            icon: 'fa-database',
                            onclick: 'loadDemoData()',
                            type: 'error-btn-secondary'
                        }
                    ]
                );
            }
        }
        
        async function handleGenericError(error) {
            console.error('Generic error:', error);
            
            if (await tryFallbackData()) {
                showNotification('âš ï¸ Connection issue. Using cached data.', 'warning');
            } else {
                ErrorHandler.show(
                    'Connection Error',
                    `Something went wrong while loading the data: ${error.message || 'Unknown error'}. Please try again.`,
                    [
                        {
                            text: 'Try Again',
                            icon: 'fa-redo',
                            onclick: 'retryDataLoad()',
                            type: 'error-btn-primary'
                        },
                        {
                            text: 'Use Demo Data',
                            icon: 'fa-database',
                            onclick: 'loadDemoData()',
                            type: 'error-btn-secondary'
                        }
                    ]
                );
            }
        }
        
        // Try to load fallback data
        async function tryFallbackData() {
            try {
                if (window.FALLBACK_GREEN_SPACES && window.FALLBACK_GREEN_SPACES.features) {
                    loadingManager.show('Loading Cached Data', 'Using offline data...');
                    loadingManager.setProgress(50);
                    
                    allGreenSpaces = window.FALLBACK_GREEN_SPACES.features || [];
                    
                    // Convert area_sq_m to area_hectares for consistency
                    allGreenSpaces.forEach(space => {
                        if (space.properties.area_sq_m && !space.properties.area_hectares) {
                            space.properties.area_hectares = space.properties.area_sq_m / 10000;
                        }
                    });
                    
                    loadingManager.setProgress(80);
                    displayGreenSpaces(allGreenSpaces);
                    updateStatistics(allGreenSpaces);
                    populateWardFilter(allGreenSpaces);
                    
                    loadingManager.setProgress(100);
                    setTimeout(() => loadingManager.hide(), 500);
                    
                    console.log(`âœ… Loaded ${allGreenSpaces.length} green spaces from fallback data`);
                    return true;
                }
            } catch (error) {
                console.error('Failed to load fallback data:', error);
            }
            return false;
        }
        
        // Global retry function
        window.retryDataLoad = function() {
            ErrorHandler.hide();
            retryAttempts = 0;
            loadGreenSpaces();
        };
        
        // Global demo data loader
        window.loadDemoData = function() {
            ErrorHandler.hide();
            tryFallbackData();
        };
        
        // Display green spaces on map
        function displayGreenSpaces(greenSpaces) {
            console.log(`ðŸ—ºï¸ Displaying ${greenSpaces.length} green spaces on map`);
            
            // Clear existing markers
            allMarkers.forEach(marker => marker.remove());
            allMarkers = [];
            Object.values(layerGroups).forEach(layer => layer.clearLayers());
            
            const typeColors = {
                'park': '#4CAF50',
                'garden': '#2196F3',
                'forest': '#9C27B0',
                'recreational': '#FF9800',
                'golf course': '#795548',
                'other': '#607D8B'
            };
            
            greenSpaces.forEach(feature => {
                const props = feature.properties;
                const coords = feature.geometry.coordinates;
                const color = typeColors[props.type] || typeColors.other;
                
                // Create custom icon
                const icon = L.divIcon({
                    html: `<div style="
                        width: 28px;
                        height: 28px;
                        background-color: ${color};
                        border: 3px solid white;
                        border-radius: 50%;
                        box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 12px;
                    ">${props.type.charAt(0).toUpperCase()}</div>`,
                    iconSize: [28, 28],
                    className: 'custom-marker'
                });
                
                // Create marker
                const marker = L.marker([coords[1], coords[0]], { icon: icon })
                    .addTo(layerGroups[props.type] || layerGroups.other);
                
                // Create popup with enhanced information
                const area_hectares = props.area_hectares || (props.area_sq_m ? props.area_sq_m / 10000 : 1.5);
                const area_ha = area_hectares.toFixed(2);
                const area_acres = (area_hectares * 2.47105).toFixed(2);
                const area_sq_m = props.area_sq_m || (area_hectares * 10000);
                
                const popupContent = `
                    <div style="min-width: 320px; font-family: 'Segoe UI', sans-serif; line-height: 1.4; max-height: 500px; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, ${color}, ${color}dd); color: white; margin: -10px -10px 15px -10px; padding: 15px; border-radius: 8px 8px 0 0;">
                            <h5 style="margin: 0; font-size: 18px; font-weight: 600;">
                                <i class="fas fa-tree" style="margin-right: 8px;"></i>${props.name}
                            </h5>
                            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">
                                <i class="fas fa-map-marker-alt" style="margin-right: 5px;"></i>${props.ward || 'Location not specified'}
                            </p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; font-weight: 700; color: ${color};">${area_ha}</div>
                                <div style="font-size: 12px; color: #666; font-weight: 500;">Hectares</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 20px; font-weight: 700; color: ${color};">${area_acres}</div>
                                <div style="font-size: 12px; color: #666; font-weight: 500;">Acres</div>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                            <h6 style="margin: 0 0 8px 0; color: #333; font-size: 14px; font-weight: 600;">
                                <i class="fas fa-info-circle" style="margin-right: 6px; color: ${color};"></i>Details
                            </h6>
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 12px; font-size: 13px;">
                                <strong>Type:</strong> <span style="text-transform: capitalize; color: ${color}; font-weight: 500;">${props.type}</span>
                                <strong>Area:</strong> <span>${area_sq_m.toLocaleString()} mÂ²</span>
                                <strong>ID:</strong> <span>#${props.id}</span>
                                <strong>Status:</strong> <span style="color: #28a745; font-weight: 500;">Active</span>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                            <h6 style="margin: 0 0 8px 0; color: #333; font-size: 14px; font-weight: 600;">
                                <i class="fas fa-leaf" style="margin-right: 6px; color: #28a745;"></i>Environmental Impact
                            </h6>
                            <div style="font-size: 13px; color: #666;">
                                <div style="margin-bottom: 4px;">
                                    <i class="fas fa-wind" style="margin-right: 6px; color: #17a2b8;"></i>
                                    Est. COâ‚‚ absorbed: <strong>${Math.round(area_sq_m * 0.0002)} kg/year</strong>
                                </div>
                                <div style="margin-bottom: 4px;">
                                    <i class="fas fa-tint" style="margin-right: 6px; color: #007bff;"></i>
                                    Rainwater capacity: <strong>${Math.round(area_sq_m * 0.001)} L</strong>
                                </div>
                                <div>
                                    <i class="fas fa-thermometer-half" style="margin-right: 6px; color: #fd7e14;"></i>
                                    Cooling effect: <strong>${Math.round(area_sq_m * 0.00001)} Â°C</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                            <h6 style="margin: 0 0 8px 0; color: #333; font-size: 14px; font-weight: 600;">
                                <i class="fas fa-users" style="margin-right: 6px; color: #6f42c1;"></i>Community Benefits
                            </h6>
                            <div style="font-size: 13px; color: #666;">
                                <div style="margin-bottom: 4px;">
                                    <i class="fas fa-walking" style="margin-right: 6px; color: #28a745;"></i>
                                    Recreation space for <strong>${Math.round(area_sq_m / 100)}</strong> people
                                </div>
                                <div style="margin-bottom: 4px;">
                                    <i class="fas fa-home" style="margin-right: 6px; color: #dc3545;"></i>
                                    Property value boost: <strong>+${Math.round(area_sq_m * 0.00001)}%</strong>
                                </div>
                                <div>
                                    <i class="fas fa-heart" style="margin-right: 6px; color: #e83e8c;"></i>
                                    Health benefit radius: <strong>${Math.round(Math.sqrt(area_sq_m / Math.PI))}m</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 8px; margin-top: 15px;">
                            <button onclick="showDetailedInfo(${props.id})" 
                                    style="flex: 1; background: ${color}; color: white; border: none; padding: 10px 15px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                <i class="fas fa-info-circle" style="margin-right: 6px;"></i>More Details
                            </button>
                            <button onclick="window.location.href='feedback.html?space=${props.id}'" 
                                    style="flex: 1; background: white; color: ${color}; border: 2px solid ${color}; padding: 10px 15px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                                <i class="fas fa-flag" style="margin-right: 6px;"></i>Report Issue
                            </button>
                        </div>
                        
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; font-size: 11px; color: #999; text-align: center;">
                            <i class="fas fa-map-marked-alt" style="margin-right: 4px;"></i>
                            Coordinates: ${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent, {
                    maxWidth: 400,
                    maxHeight: 500,
                    autoPan: true,
                    keepInView: true,
                    className: 'custom-popup'
                });
                allMarkers.push(marker);
            });
        }
        
        // Update statistics with intro stats
        function updateStatistics(greenSpaces) {
            const totalSpaces = greenSpaces.length;
            // Use area_hectares if available, otherwise convert from area_sq_m
            const totalAreaHa = greenSpaces.reduce((sum, space) => {
                const props = space.properties;
                if (props.area_hectares && props.area_hectares > 0) {
                    return sum + parseFloat(props.area_hectares);
                } else if (props.area_sq_m && props.area_sq_m > 0) {
                    return sum + (parseFloat(props.area_sq_m) / 10000);
                }
                // Fallback for spaces without area data
                return sum + 1.5; // Assume 1.5 hectares average
            }, 0);
            
            const wards = [...new Set(greenSpaces.map(space => space.properties.ward).filter(Boolean))];
            
            const statSpaces = document.getElementById('statSpaces');
            const statArea = document.getElementById('statArea');
            const statWards = document.getElementById('statWards');
            
            // Update main stats
            if (statSpaces) statSpaces.textContent = totalSpaces;
            if (statArea) statArea.textContent = Math.round(totalAreaHa * 10) / 10; // Round to 1 decimal
            if (statWards) statWards.textContent = wards.length;
            
            // Update intro stats
            const totalSpacesIntro = document.getElementById('totalSpacesIntro');
            const totalWardsIntro = document.getElementById('totalWardsIntro');
            if (totalSpacesIntro) totalSpacesIntro.textContent = totalSpaces;
            if (totalWardsIntro) totalWardsIntro.textContent = wards.length;
            
            console.log(`ðŸ“Š Stats updated: ${totalSpaces} spaces, ${Math.round(totalAreaHa * 10) / 10} ha, ${wards.length} wards`);
        }
        
        // Setup tooltips system
        function setupTooltips() {
            const tooltipBtns = document.querySelectorAll('[data-tooltip]');
            tooltipBtns.forEach(btn => {
                btn.addEventListener('mouseenter', function(e) {
                    showTooltip(e.target, this.dataset.tooltip);
                });
                
                btn.addEventListener('mouseleave', function() {
                    hideTooltip();
                });
                
                btn.addEventListener('focus', function(e) {
                    showTooltip(e.target, this.dataset.tooltip);
                });
                
                btn.addEventListener('blur', function() {
                    hideTooltip();
                });
            });
        }
        
        function showTooltip(element, text) {
            hideTooltip(); // Remove any existing tooltip
            
            const tooltip = document.createElement('div');
            tooltip.className = 'custom-tooltip';
            tooltip.textContent = text;
            tooltip.style.cssText = `
                position: absolute;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                font-weight: 500;
                z-index: 10000;
                pointer-events: none;
                white-space: nowrap;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
            `;
            
            document.body.appendChild(tooltip);
            
            const rect = element.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
            let top = rect.top - tooltipRect.height - 8;
            
            // Adjust if tooltip goes off screen
            if (left < 8) left = 8;
            if (left + tooltipRect.width > window.innerWidth - 8) {
                left = window.innerWidth - tooltipRect.width - 8;
            }
            if (top < 8) {
                top = rect.bottom + 8;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.style.opacity = '0';
            tooltip.style.transform = 'translateY(4px)';
            tooltip.style.transition = 'all 0.2s ease';
            
            setTimeout(() => {
                tooltip.style.opacity = '1';
                tooltip.style.transform = 'translateY(0)';
            }, 10);
        }
        
        function hideTooltip() {
            const tooltip = document.querySelector('.custom-tooltip');
            if (tooltip) {
                tooltip.style.opacity = '0';
                tooltip.style.transform = 'translateY(4px)';
                setTimeout(() => tooltip.remove(), 200);
            }
        }
        
        // Accessibility settings functions
        function loadAccessibilitySettings() {
            const settings = JSON.parse(localStorage.getItem('accessibilitySettings') || '{}');
            
            // Apply saved settings
            if (settings.highContrastMode) {
                document.body.classList.add('high-contrast');
                document.getElementById('highContrastMode').checked = true;
            }
            
            if (settings.largeText) {
                document.body.classList.add('large-text');
                document.getElementById('largeText').checked = true;
            }
            
            if (settings.reducedMotion) {
                document.body.classList.add('reduced-motion');
                document.getElementById('reducedMotion').checked = true;
            }
            
            if (settings.colorBlindMode) {
                document.body.classList.add('color-blind-mode');
                document.getElementById('colorBlindMode').checked = true;
            }
            
            if (settings.screenReaderMode) {
                document.body.classList.add('screen-reader-mode');
                document.getElementById('screenReaderMode').checked = true;
                enhanceScreenReaderSupport();
            }
        }
        
        function saveAccessibilitySettings() {
            const settings = {
                highContrastMode: document.getElementById('highContrastMode').checked,
                largeText: document.getElementById('largeText').checked,
                reducedMotion: document.getElementById('reducedMotion').checked,
                colorBlindMode: document.getElementById('colorBlindMode').checked,
                keyboardNavigation: document.getElementById('keyboardNavigation').checked,
                focusIndicators: document.getElementById('focusIndicators').checked,
                skipLinks: document.getElementById('skipLinks').checked,
                screenReaderMode: document.getElementById('screenReaderMode').checked
            };
            
            localStorage.setItem('accessibilitySettings', JSON.stringify(settings));
            
            // Apply settings immediately
            document.body.classList.toggle('high-contrast', settings.highContrastMode);
            document.body.classList.toggle('large-text', settings.largeText);
            document.body.classList.toggle('reduced-motion', settings.reducedMotion);
            document.body.classList.toggle('color-blind-mode', settings.colorBlindMode);
            document.body.classList.toggle('screen-reader-mode', settings.screenReaderMode);
            
            if (settings.screenReaderMode) {
                enhanceScreenReaderSupport();
            }
            
            showNotification('âœ… Accessibility settings saved successfully!', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('accessibilityModal'));
            modal.hide();
        }
        
        function resetAccessibilitySettings() {
            // Reset all checkboxes
            document.getElementById('highContrastMode').checked = false;
            document.getElementById('largeText').checked = false;
            document.getElementById('reducedMotion').checked = false;
            document.getElementById('colorBlindMode').checked = false;
            document.getElementById('keyboardNavigation').checked = true;
            document.getElementById('focusIndicators').checked = true;
            document.getElementById('skipLinks').checked = false;
            document.getElementById('screenReaderMode').checked = false;
            
            // Remove all accessibility classes
            document.body.classList.remove('high-contrast', 'large-text', 'reduced-motion', 'color-blind-mode', 'screen-reader-mode');
            
            // Clear localStorage
            localStorage.removeItem('accessibilitySettings');
            
            showNotification('ðŸ”„ Accessibility settings reset to default', 'info');
        }
        
        function enhanceScreenReaderSupport() {
            // Add more descriptive ARIA labels
            const markers = document.querySelectorAll('.custom-marker');
            markers.forEach((marker, index) => {
                const space = allGreenSpaces[index];
                if (space) {
                    const props = space.properties;
                    const description = `${props.name}, ${props.type} in ${props.ward || 'Kitwe'}, area ${props.area_sq_m || 'unknown'} square meters`;
                    marker.setAttribute('aria-label', description);
                    marker.setAttribute('role', 'button');
                    marker.setAttribute('tabindex', '0');
                }
            });
            
            // Add live region for dynamic updates
            if (!document.getElementById('liveRegion')) {
                const liveRegion = document.createElement('div');
                liveRegion.id = 'liveRegion';
                liveRegion.setAttribute('aria-live', 'polite');
                liveRegion.setAttribute('aria-atomic', 'true');
                liveRegion.style.cssText = 'position: absolute; left: -10000px; width: 1px; height: 1px; overflow: hidden;';
                document.body.appendChild(liveRegion);
            }
        }
        
        // Announce changes to screen readers
        function announceToScreenReader(message) {
            const liveRegion = document.getElementById('liveRegion');
            if (liveRegion) {
                liveRegion.textContent = message;
            }
        }
        
        // Make functions globally accessible
        window.saveAccessibilitySettings = saveAccessibilitySettings;
        window.resetAccessibilitySettings = resetAccessibilitySettings;
        
        // Populate ward filter
        function populateWardFilter(greenSpaces) {
            const wardSelect = document.getElementById('filterWard');
            if (!wardSelect) return;
            
            const wards = [...new Set(greenSpaces.map(space => space.properties.ward).filter(Boolean))].sort();
            
            // Clear existing options (keep "All Wards")
            while (wardSelect.options.length > 1) {
                wardSelect.remove(1);
            }
            
            // Add ward options
            wards.forEach(ward => {
                const option = document.createElement('option');
                option.value = ward;
                option.textContent = ward;
                wardSelect.appendChild(option);
            });
        }
        
        // Enhanced filter functions with loading states
        function applyFilters() {
            const btn = document.getElementById('applyFilters');
            ButtonLoader.setLoading(btn, true);
            
            try {
                const typeFilter = document.getElementById('filterType').value;
                const wardFilter = document.getElementById('filterWard').value;
                const areaFilter = parseInt(document.getElementById('areaRange').value);
                
                showNotification('ðŸ” Applying filters...', 'info');
                
                const filtered = allGreenSpaces.filter(space => {
                    const props = space.properties;
                    
                    if (typeFilter !== 'all' && props.type !== typeFilter) return false;
                    if (wardFilter !== 'all' && props.ward !== wardFilter) return false;
                    if ((props.area_sq_m || 0) < areaFilter) return false;
                    
                    return true;
                });
                
                // Simulate processing time for better UX
                setTimeout(() => {
                    displayGreenSpaces(filtered);
                    updateStatistics(filtered);
                    
                    ButtonLoader.setLoading(btn, false);
                    showNotification(`âœ… Showing ${filtered.length} filtered green spaces`, 'success');
                }, 300);
                
            } catch (error) {
                ButtonLoader.setLoading(btn, false);
                showNotification(`âŒ Filter error: ${error.message}`, 'error');
            }
        }
        
        function resetFilters() {
            const btn = document.getElementById('resetFilters');
            ButtonLoader.setLoading(btn, true);
            
            try {
                document.getElementById('filterType').value = 'all';
                document.getElementById('filterWard').value = 'all';
                document.getElementById('areaRange').value = 0;
                document.getElementById('areaValue').textContent = '0 mÂ²';
                
                showNotification('ðŸ”„ Resetting filters...', 'info');
                
                setTimeout(() => {
                    displayGreenSpaces(allGreenSpaces);
                    updateStatistics(allGreenSpaces);
                    
                    ButtonLoader.setLoading(btn, false);
                    showNotification('âœ… Filters reset', 'success');
                }, 200);
                
            } catch (error) {
                ButtonLoader.setLoading(btn, false);
                showNotification(`âŒ Reset error: ${error.message}`, 'error');
            }
        }
        
        // Enhanced control functions with loading states
        function findUserLocation() {
            const btn = document.getElementById('locateBtn');
            if (!navigator.geolocation) {
                showNotification('âŒ Geolocation is not supported by this browser', 'error');
                return;
            }
            
            ButtonLoader.setLoading(btn, true);
            
            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            };
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    map.setView([lat, lng], 16);
                    
                    // Create a circle to show accuracy
                    const circle = L.circle([lat, lng], {
                        radius: accuracy,
                        color: '#4CAF50',
                        fillColor: '#4CAF50',
                        fillOpacity: 0.1,
                        weight: 2
                    }).addTo(map);
                    
                    const marker = L.marker([lat, lng])
                        .addTo(map)
                        .bindPopup(`
                            <div style="text-align: center; font-family: var(--font-family-primary);">
                                <h6 style="color: var(--primary-color); margin-bottom: 8px;">
                                    <i class="fas fa-location-arrow me-2"></i>Your Location
                                </h6>
                                <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
                                    Accuracy: Â±${Math.round(accuracy)}m
                                </p>
                                <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--text-tertiary);">
                                    ${lat.toFixed(6)}, ${lng.toFixed(6)}
                                </p>
                            </div>
                        `)
                        .openPopup();
                    
                    ButtonLoader.setLoading(btn, false);
                    showNotification(`ðŸ“ Location found! Accuracy: Â±${Math.round(accuracy)}m`, 'success');
                    
                    // Remove location marker after 30 seconds
                    setTimeout(() => {
                        map.removeLayer(marker);
                        map.removeLayer(circle);
                    }, 30000);
                },
                function(error) {
                    ButtonLoader.setLoading(btn, false);
                    
                    let errorMessage = 'Could not get your location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied. Please enable location permissions.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out. Please try again.';
                            break;
                    }
                    
                    showNotification(`âŒ ${errorMessage}`, 'error');
                },
                options
            );
        }
        
        function toggleFullscreen() {
            const btn = document.getElementById('fullscreenBtn');
            
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    btn.innerHTML = '<i class="fas fa-compress"></i>';
                    showNotification('ðŸ“º Entered fullscreen mode', 'info');
                }).catch(err => {
                    showNotification('âŒ Could not enter fullscreen mode', 'error');
                });
            } else {
                document.exitFullscreen().then(() => {
                    btn.innerHTML = '<i class="fas fa-expand"></i>';
                    showNotification('ðŸ“º Exited fullscreen mode', 'info');
                }).catch(err => {
                    showNotification('âŒ Could not exit fullscreen mode', 'error');
                });
            }
        }
        
        function refreshData() {
            const btn = document.getElementById('refreshBtn');
            ButtonLoader.setLoading(btn, true);
            
            // Reset retry attempts
            retryAttempts = 0;
            
            loadGreenSpaces().finally(() => {
                ButtonLoader.setLoading(btn, false);
            });
        }
        
        // Show detailed information modal
        function showDetailedInfo(spaceId) {
            const space = allGreenSpaces.find(s => s.properties.id === spaceId);
            if (!space) {
                showNotification('Green space not found', 'error');
                return;
            }
            
            const props = space.properties;
            const coords = space.geometry.coordinates;
            const typeColors = {
                'park': '#4CAF50',
                'garden': '#2196F3',
                'forest': '#9C27B0',
                'recreational': '#FF9800',
                'golf course': '#795548',
                'other': '#607D8B'
            };
            const color = typeColors[props.type] || typeColors.other;
            
            // Calculate additional metrics
            const area_ha = ((props.area_sq_m || 0) / 10000).toFixed(2);
            const area_acres = ((props.area_sq_m || 0) * 0.000247105).toFixed(2);
            const co2_absorption = Math.round((props.area_sq_m || 0) * 0.0002);
            const rainwater_capacity = Math.round((props.area_sq_m || 0) * 0.001);
            const cooling_effect = ((props.area_sq_m || 0) * 0.00001).toFixed(2);
            const recreation_capacity = Math.round((props.area_sq_m || 0) / 100);
            const property_boost = ((props.area_sq_m || 0) * 0.00001).toFixed(1);
            const health_radius = Math.round(Math.sqrt((props.area_sq_m || 0) / Math.PI));
            
            // Estimate facilities based on type and size
            const facilities = getFacilitiesForSpace(props.type, props.area_sq_m || 0);
            const accessibility = getAccessibilityInfo(props.type);
            const maintenance = getMaintenanceInfo(props.type, props.area_sq_m || 0);
            
            const modalContent = `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header" style="background: ${color}; color: white;">
                                <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr><td><strong>Name:</strong></td><td>${props.name}</td></tr>
                                    <tr><td><strong>Type:</strong></td><td style="text-transform: capitalize; color: ${color}; font-weight: 600;">${props.type}</td></tr>
                                    <tr><td><strong>Ward:</strong></td><td>${props.ward || 'Not specified'}</td></tr>
                                    <tr><td><strong>ID:</strong></td><td>#${props.id}</td></tr>
                                    <tr><td><strong>Status:</strong></td><td><span class="badge bg-success">Active</span></td></tr>
                                </table>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header" style="background: ${color}; color: white;">
                                <h6 class="mb-0"><i class="fas fa-ruler-combined me-2"></i>Area Measurements</h6>
                            </div>
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="h4 text-primary">${(props.area_sq_m || 0).toLocaleString()}</div>
                                        <small class="text-muted">Square Meters</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="h4 text-success">${area_ha}</div>
                                        <small class="text-muted">Hectares</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="h4 text-warning">${area_acres}</div>
                                        <small class="text-muted">Acres</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header" style="background: #28a745; color: white;">
                                <h6 class="mb-0"><i class="fas fa-leaf me-2"></i>Environmental Impact</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <i class="fas fa-wind text-info me-2"></i>
                                    <strong>COâ‚‚ Absorption:</strong> ${co2_absorption} kg/year
                                </div>
                                <div class="mb-2">
                                    <i class="fas fa-tint text-primary me-2"></i>
                                    <strong>Rainwater Capacity:</strong> ${rainwater_capacity.toLocaleString()} L
                                </div>
                                <div class="mb-2">
                                    <i class="fas fa-thermometer-half text-warning me-2"></i>
                                    <strong>Cooling Effect:</strong> ${cooling_effect}Â°C reduction
                                </div>
                                <div class="mb-2">
                                    <i class="fas fa-seedling text-success me-2"></i>
                                    <strong>Biodiversity:</strong> Supports local ecosystem
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header" style="background: #6f42c1; color: white;">
                                <h6 class="mb-0"><i class="fas fa-users me-2"></i>Community Benefits</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <i class="fas fa-walking text-success me-2"></i>
                                    <strong>Recreation Capacity:</strong> ${recreation_capacity} people
                                </div>
                                <div class="mb-2">
                                    <i class="fas fa-home text-danger me-2"></i>
                                    <strong>Property Value Boost:</strong> +${property_boost}%
                                </div>
                                <div class="mb-2">
                                    <i class="fas fa-heart text-pink me-2"></i>
                                    <strong>Health Benefit Radius:</strong> ${health_radius}m
                                </div>
                                <div class="mb-2">
                                    <i class="fas fa-child text-info me-2"></i>
                                    <strong>Family Friendly:</strong> ${props.area_sq_m > 5000 ? 'Yes' : 'Limited space'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header" style="background: #17a2b8; color: white;">
                                <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Facilities & Amenities</h6>
                            </div>
                            <div class="card-body">
                                ${facilities.map(facility => `
                                    <div class="mb-1">
                                        <i class="fas fa-check-circle text-success me-2"></i>${facility}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header" style="background: #fd7e14; color: white;">
                                <h6 class="mb-0"><i class="fas fa-universal-access me-2"></i>Accessibility</h6>
                            </div>
                            <div class="card-body">
                                ${accessibility.map(item => `
                                    <div class="mb-1">
                                        <i class="fas fa-info-circle text-info me-2"></i>${item}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header" style="background: #6c757d; color: white;">
                                <h6 class="mb-0"><i class="fas fa-tools me-2"></i>Maintenance Info</h6>
                            </div>
                            <div class="card-body">
                                ${maintenance.map(item => `
                                    <div class="mb-1">
                                        <i class="fas fa-wrench text-secondary me-2"></i>${item}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header" style="background: #343a40; color: white;">
                                <h6 class="mb-0"><i class="fas fa-map-marked-alt me-2"></i>Location Details</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>Coordinates:</strong><br>
                                        Latitude: ${coords[1].toFixed(6)}<br>
                                        Longitude: ${coords[0].toFixed(6)}
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Administrative:</strong><br>
                                        Ward: ${props.ward || 'Not specified'}<br>
                                        City: Kitwe, Zambia
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <button class="btn btn-outline-primary btn-sm" onclick="map.setView([${coords[1]}, ${coords[0]}], 16); bootstrap.Modal.getInstance(document.getElementById('detailModal')).hide();">
                                        <i class="fas fa-crosshairs me-1"></i>Center Map Here
                                    </button>
                                    <button class="btn btn-outline-success btn-sm ms-2" onclick="navigator.clipboard.writeText('${coords[1].toFixed(6)}, ${coords[0].toFixed(6)}'); showNotification('Coordinates copied!', 'success');">
                                        <i class="fas fa-copy me-1"></i>Copy Coordinates
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('detailModalLabel').innerHTML = `<i class="fas fa-tree me-2"></i>${props.name}`;
            document.getElementById('detailModalBody').innerHTML = modalContent;
            
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();
        }
        
        // Helper functions for detailed information
        function getFacilitiesForSpace(type, area) {
            const facilities = [];
            
            switch(type) {
                case 'park':
                    facilities.push('Walking paths');
                    if (area > 10000) facilities.push('Playground equipment');
                    if (area > 20000) facilities.push('Picnic areas');
                    if (area > 30000) facilities.push('Sports facilities');
                    facilities.push('Benches and seating');
                    facilities.push('Landscaped gardens');
                    break;
                    
                case 'garden':
                    facilities.push('Botanical displays');
                    facilities.push('Walking paths');
                    facilities.push('Educational signage');
                    if (area > 5000) facilities.push('Greenhouse');
                    facilities.push('Seating areas');
                    break;
                    
                case 'forest':
                    facilities.push('Nature trails');
                    facilities.push('Wildlife habitat');
                    facilities.push('Canopy cover');
                    if (area > 50000) facilities.push('Visitor center');
                    facilities.push('Conservation area');
                    break;
                    
                case 'recreational':
                    facilities.push('Sports equipment');
                    facilities.push('Playing fields');
                    facilities.push('Changing rooms');
                    facilities.push('Spectator seating');
                    if (area > 15000) facilities.push('Multiple courts/fields');
                    break;
                    
                case 'golf course':
                    facilities.push('Golf course (18 holes)');
                    facilities.push('Clubhouse');
                    facilities.push('Pro shop');
                    facilities.push('Driving range');
                    facilities.push('Putting green');
                    break;
                    
                default:
                    facilities.push('Open space');
                    facilities.push('Basic landscaping');
                    if (area > 5000) facilities.push('Seating areas');
            }
            
            // Common facilities for larger spaces
            if (area > 25000) {
                facilities.push('Parking area');
                facilities.push('Public restrooms');
            }
            
            return facilities;
        }
        
        function getAccessibilityInfo(type) {
            const accessibility = [
                'Public access during daylight hours',
                'Pedestrian accessible',
                'Connected to local transport'
            ];
            
            if (type === 'park' || type === 'recreational') {
                accessibility.push('Wheelchair accessible paths');
                accessibility.push('Family-friendly facilities');
            }
            
            if (type === 'garden') {
                accessibility.push('Educational tours available');
                accessibility.push('Guided walks');
            }
            
            return accessibility;
        }
        
        function getMaintenanceInfo(type, area) {
            const maintenance = [];
            
            if (area < 5000) {
                maintenance.push('Weekly maintenance schedule');
            } else if (area < 20000) {
                maintenance.push('Bi-weekly maintenance schedule');
            } else {
                maintenance.push('Daily maintenance schedule');
            }
            
            maintenance.push('Seasonal landscaping updates');
            maintenance.push('Regular safety inspections');
            
            if (type === 'park' || type === 'recreational') {
                maintenance.push('Equipment safety checks');
            }
            
            if (type === 'forest') {
                maintenance.push('Conservation management');
                maintenance.push('Wildlife monitoring');
            }
            
            maintenance.push('Community volunteer programs');
            
            return maintenance;
        }
        
        // Make functions globally accessible
        window.showDetailedInfo = showDetailedInfo;
        window.exportAnalytics = exportAnalytics;
        
        // Enhanced Data Export Function with loading states
        function exportData() {
            const btn = document.getElementById('exportDataBtn');
            ButtonLoader.setLoading(btn, true);
            
            try {
                if (!allGreenSpaces || allGreenSpaces.length === 0) {
                    throw new Error('No data available to export');
                }
                
                showNotification('ðŸ“Š Preparing export...', 'info');
                
                // Create comprehensive dataset
                const exportData = {
                    metadata: {
                        title: "Kitwe Green Spaces Dataset",
                        generated: new Date().toISOString(),
                        total_spaces: allGreenSpaces.length,
                        data_source: "Kitwe Municipal GIS Database",
                        coordinate_system: "WGS84 (EPSG:4326)",
                        export_version: "2.0"
                    },
                    summary_statistics: calculateSummaryStats(),
                    green_spaces: allGreenSpaces.map(space => ({
                        id: space.properties.id,
                        name: space.properties.name,
                        type: space.properties.type,
                        ward: space.properties.ward,
                        area_sqm: space.properties.area_sq_m,
                        area_hectares: (space.properties.area_sq_m / 10000).toFixed(2),
                        coordinates: {
                            latitude: space.geometry.coordinates[1],
                            longitude: space.geometry.coordinates[0]
                        },
                        environmental_impact: {
                            co2_absorption_kg_year: Math.round(space.properties.area_sq_m * 0.0002),
                            rainwater_capacity_liters: Math.round(space.properties.area_sq_m * 0.001),
                            cooling_effect_celsius: (space.properties.area_sq_m * 0.00001).toFixed(2)
                        }
                    }))
                };
                
                // Export as JSON
                const jsonData = JSON.stringify(exportData, null, 2);
                downloadFile(jsonData, 'kitwe_green_spaces_data.json', 'application/json');
                
                // Also create CSV for Excel compatibility
                const csvData = convertToCSV(exportData.green_spaces);
                downloadFile(csvData, 'kitwe_green_spaces_data.csv', 'text/csv');
                
                showNotification('âœ… Data exported successfully! (JSON & CSV formats)', 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showNotification(`âŒ Export failed: ${error.message}`, 'error');
            } finally {
                ButtonLoader.setLoading(btn, false);
            }
        }
        
        // Enhanced Analytics Function with loading states
        function showAdvancedAnalytics() {
            const btn = document.getElementById('analyticsBtn');
            
            if (allGreenSpaces.length === 0) {
                showNotification('âŒ Please wait for data to load before viewing analytics', 'error');
                return;
            }
            
            ButtonLoader.setLoading(btn, true);
            
            try {
                showNotification('ðŸ“Š Generating analytics...', 'info');
                
                // Calculate advanced metrics
                const analytics = calculateAdvancedAnalytics();
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('analyticsModal'));
                modal.show();
                
                // Wait for modal to be shown, then create charts
                document.getElementById('analyticsModal').addEventListener('shown.bs.modal', function() {
                    try {
                        createDistributionChart(analytics.typeDistribution);
                        createWardChart(analytics.wardAnalysis);
                        displayEnvironmentalMetrics(analytics.environmental);
                        displayRecommendations(analytics.recommendations);
                        
                        showNotification('âœ… Analytics generated successfully!', 'success');
                    } catch (error) {
                        console.error('Chart creation error:', error);
                        showNotification('âš ï¸ Some charts could not be generated', 'warning');
                    }
                }, { once: true });
                
            } catch (error) {
                console.error('Analytics error:', error);
                showNotification(`âŒ Analytics failed: ${error.message}`, 'error');
            } finally {
                ButtonLoader.setLoading(btn, false);
            }
        }
        
        // Calculate Summary Statistics
        function calculateSummaryStats() {
            const totalArea = allGreenSpaces.reduce((sum, space) => sum + (space.properties.area_sq_m || 0), 0);
            const types = [...new Set(allGreenSpaces.map(space => space.properties.type))];
            const wards = [...new Set(allGreenSpaces.map(space => space.properties.ward))];
            
            return {
                total_spaces: allGreenSpaces.length,
                total_area_sqm: totalArea,
                total_area_hectares: (totalArea / 10000).toFixed(2),
                average_space_size_sqm: Math.round(totalArea / allGreenSpaces.length),
                unique_types: types.length,
                unique_wards: wards.length,
                largest_space: allGreenSpaces.reduce((max, space) => 
                    (space.properties.area_sq_m || 0) > (max.properties.area_sq_m || 0) ? space : max
                ).properties.name,
                smallest_space: allGreenSpaces.reduce((min, space) => 
                    (space.properties.area_sq_m || 0) < (min.properties.area_sq_m || 0) ? space : min
                ).properties.name
            };
        }
        
        // Calculate Advanced Analytics
        function calculateAdvancedAnalytics() {
            // Type distribution
            const typeDistribution = {};
            allGreenSpaces.forEach(space => {
                const type = space.properties.type;
                typeDistribution[type] = (typeDistribution[type] || 0) + 1;
            });
            
            // Ward analysis
            const wardAnalysis = {};
            allGreenSpaces.forEach(space => {
                const ward = space.properties.ward || 'Unknown';
                if (!wardAnalysis[ward]) {
                    wardAnalysis[ward] = { count: 0, totalArea: 0 };
                }
                wardAnalysis[ward].count++;
                wardAnalysis[ward].totalArea += space.properties.area_sq_m || 0;
            });
            
            // Environmental impact
            const totalArea = allGreenSpaces.reduce((sum, space) => sum + (space.properties.area_sq_m || 0), 0);
            const environmental = {
                totalCO2Absorption: Math.round(totalArea * 0.0002),
                totalRainwaterCapacity: Math.round(totalArea * 0.001),
                averageCoolingEffect: (totalArea * 0.00001).toFixed(2),
                biodiversityIndex: calculateBiodiversityIndex(),
                greenSpacePerCapita: (totalArea / 517543).toFixed(2) // Kitwe population estimate
            };
            
            // Urban planning recommendations
            const recommendations = generateRecommendations(wardAnalysis, environmental);
            
            return {
                typeDistribution,
                wardAnalysis,
                environmental,
                recommendations
            };
        }
        
        // Create Distribution Chart
        function createDistributionChart(data) {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: [
                            '#4CAF50', '#2196F3', '#9C27B0', '#FF9800', '#795548', '#607D8B'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Distribution by Type'
                        }
                    }
                }
            });
        }
        
        // Create Ward Chart
        function createWardChart(data) {
            const ctx = document.getElementById('wardChart').getContext('2d');
            const wards = Object.keys(data).slice(0, 10); // Top 10 wards
            const areas = wards.map(ward => (data[ward].totalArea / 10000).toFixed(1)); // Convert to hectares
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: wards,
                    datasets: [{
                        label: 'Area (Hectares)',
                        data: areas,
                        backgroundColor: 'rgba(76, 175, 80, 0.8)',
                        borderColor: 'rgba(76, 175, 80, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Area (Hectares)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Wards'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Green Space Coverage by Ward'
                        }
                    }
                }
            });
        }
        
        // Display Environmental Metrics
        function displayEnvironmentalMetrics(environmental) {
            const container = document.getElementById('environmentalMetrics');
            container.innerHTML = `
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h4 class="text-success">${environmental.totalCO2Absorption.toLocaleString()}</h4>
                        <small>kg COâ‚‚ absorbed/year</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h4 class="text-primary">${environmental.totalRainwaterCapacity.toLocaleString()}</h4>
                        <small>Liters rainwater capacity</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h4 class="text-warning">${environmental.averageCoolingEffect}Â°C</h4>
                        <small>Average cooling effect</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-3 bg-light rounded">
                        <h4 class="text-info">${environmental.greenSpacePerCapita}</h4>
                        <small>mÂ² per capita</small>
                    </div>
                </div>
            `;
        }
        
        // Generate Urban Planning Recommendations
        function generateRecommendations(wardAnalysis, environmental) {
            const recommendations = [];
            
            // Analyze ward coverage
            const wardsByArea = Object.entries(wardAnalysis)
                .sort((a, b) => b[1].totalArea - a[1].totalArea);
            
            const lowCoverageWards = wardsByArea.slice(-3);
            
            recommendations.push({
                category: "Spatial Equity",
                priority: "High",
                recommendation: `Increase green space development in ${lowCoverageWards.map(w => w[0]).join(', ')} - these wards have the lowest green space coverage.`
            });
            
            // WHO standard is 9mÂ² per capita
            const currentPerCapita = parseFloat(environmental.greenSpacePerCapita);
            if (currentPerCapita < 9) {
                recommendations.push({
                    category: "WHO Standards",
                    priority: "Medium",
                    recommendation: `Current green space per capita (${currentPerCapita}mÂ²) is below WHO recommendation (9mÂ²). Consider developing ${Math.round((9 - currentPerCapita) * 517543 / 10000)} additional hectares.`
                });
            }
            
            recommendations.push({
                category: "Environmental Impact",
                priority: "Medium",
                recommendation: `Current green spaces absorb ${environmental.totalCO2Absorption.toLocaleString()}kg COâ‚‚ annually. Expanding by 20% could increase absorption to ${Math.round(environmental.totalCO2Absorption * 1.2).toLocaleString()}kg/year.`
            });
            
            recommendations.push({
                category: "Connectivity",
                priority: "Low",
                recommendation: "Develop green corridors connecting isolated spaces to create ecological networks and improve biodiversity."
            });
            
            return recommendations;
        }
        
        // Calculate Biodiversity Index (simplified)
        function calculateBiodiversityIndex() {
            const types = [...new Set(allGreenSpaces.map(space => space.properties.type))];
            const totalSpaces = allGreenSpaces.length;
            
            // Shannon Diversity Index approximation
            let diversity = 0;
            types.forEach(type => {
                const count = allGreenSpaces.filter(space => space.properties.type === type).length;
                const proportion = count / totalSpaces;
                diversity -= proportion * Math.log(proportion);
            });
            
            return diversity.toFixed(2);
        }
        
        // Display Recommendations
        function displayRecommendations(recommendations) {
            const container = document.getElementById('recommendations');
            container.innerHTML = recommendations.map(rec => `
                <div class="alert alert-${rec.priority === 'High' ? 'danger' : rec.priority === 'Medium' ? 'warning' : 'info'} mb-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${rec.category}</strong>
                            <p class="mb-0 mt-1">${rec.recommendation}</p>
                        </div>
                        <span class="badge bg-${rec.priority === 'High' ? 'danger' : rec.priority === 'Medium' ? 'warning' : 'info'}">${rec.priority}</span>
                    </div>
                </div>
            `).join('');
        }
        
        // Export Analytics Report
        function exportAnalytics() {
            const analytics = calculateAdvancedAnalytics();
            const report = {
                title: "Kitwe Green Spaces - Advanced Analytics Report",
                generated: new Date().toISOString(),
                summary: calculateSummaryStats(),
                analytics: analytics,
                methodology: {
                    co2_calculation: "Area (mÂ²) Ã— 0.0002 kg/mÂ²/year",
                    rainwater_calculation: "Area (mÂ²) Ã— 0.001 L/mÂ²",
                    cooling_calculation: "Area (mÂ²) Ã— 0.00001 Â°C/mÂ²",
                    biodiversity_index: "Shannon Diversity Index",
                    data_source: "Municipal GIS Database"
                }
            };
            
            const reportData = JSON.stringify(report, null, 2);
            downloadFile(reportData, 'kitwe_green_spaces_analytics_report.json', 'application/json');
            showNotification('Analytics report exported successfully!', 'success');
        }
        
        // Utility Functions
        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => {
                    const value = row[header];
                    return typeof value === 'object' ? JSON.stringify(value) : value;
                }).join(','))
            ].join('\n');
            return csvContent;
        }
        
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);
        }
        
        // Enhanced notification system
        function showNotification(message, type = 'info', duration = 4000) {
            // Remove existing notifications of the same type
            const existingNotifications = document.querySelectorAll(`.notification-${type}`);
            existingNotifications.forEach(notification => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            });
            
            const colors = {
                success: {
                    bg: 'rgba(76, 175, 80, 0.95)',
                    icon: 'fa-check-circle',
                    border: '#4CAF50'
                },
                error: {
                    bg: 'rgba(244, 67, 54, 0.95)',
                    icon: 'fa-exclamation-circle',
                    border: '#f44336'
                },
                warning: {
                    bg: 'rgba(255, 152, 0, 0.95)',
                    icon: 'fa-exclamation-triangle',
                    border: '#FF9800'
                },
                info: {
                    bg: 'rgba(33, 150, 243, 0.95)',
                    icon: 'fa-info-circle',
                    border: '#2196F3'
                }
            };
            
            const config = colors[type] || colors.info;
            
            const notification = document.createElement('div');
            notification.className = `notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: calc(var(--navbar-height) + var(--spacing-md));
                right: var(--spacing-md);
                background: ${config.bg};
                backdrop-filter: blur(20px);
                color: var(--text-inverse);
                padding: var(--spacing-md) var(--spacing-lg);
                border-radius: var(--border-radius-md);
                box-shadow: var(--shadow-xl);
                z-index: 9999;
                font-weight: var(--font-weight-medium);
                font-size: var(--font-size-sm);
                max-width: 350px;
                min-width: 250px;
                animation: slideIn 0.3s ease;
                border-left: 4px solid ${config.border};
                font-family: var(--font-family-primary);
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: var(--spacing-md);">
                    <i class="fas ${config.icon}" style="font-size: var(--font-size-base); margin-top: 2px; flex-shrink: 0;"></i>
                    <div style="flex: 1;">
                        <div style="line-height: 1.4;">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: none; 
                        border: none; 
                        color: var(--text-inverse); 
                        cursor: pointer; 
                        padding: 2px; 
                        border-radius: 50%; 
                        width: 20px; 
                        height: 20px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center;
                        opacity: 0.7;
                        transition: opacity var(--transition-fast);
                        flex-shrink: 0;
                    " onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">
                        <i class="fas fa-times" style="font-size: 12px;"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after duration
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
            
            // Add click to dismiss
            notification.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'I') {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            });
        }
        
        // Enhanced error display function
        function showError(message, details = null, actions = []) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }
            
            // Use the ErrorHandler class for consistent error display
            const defaultActions = [
                {
                    text: 'Retry',
                    icon: 'fa-redo',
                    onclick: 'retryDataLoad()',
                    type: 'error-btn-primary'
                },
                {
                    text: 'Use Demo Data',
                    icon: 'fa-database',
                    onclick: 'loadDemoData()',
                    type: 'error-btn-secondary'
                }
            ];
            
            const errorActions = actions.length > 0 ? actions : defaultActions;
            const errorMessage = details ? `${message}\n\nDetails: ${details}` : message;
            
            ErrorHandler.show('System Error', errorMessage, errorActions);
            showNotification(message, 'error', 6000);
        }
        
        // Enhanced connection test function
        async function testConnection() {
            try {
                showNotification('ðŸ” Testing connection...', 'info');
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(`${window.APP_CONFIG.API_BASE_URL}/api/health`, {
                    method: 'GET',
                    signal: controller.signal,
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const data = await response.json();
                    showNotification('âœ… Connection successful!', 'success');
                    return true;
                } else {
                    throw new Error(`Server responded with status ${response.status}`);
                }
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    showNotification('â±ï¸ Connection test timed out', 'warning');
                } else {
                    showNotification(`âŒ Connection failed: ${error.message}`, 'error');
                }
                return false;
            }
        }
        
        // Add connection test to global scope
        window.testConnection = testConnection;
        
        /* Add CSS animations and enhanced styles */
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            @keyframes bounce {
                0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                40% { transform: translateY(-10px); }
                60% { transform: translateY(-5px); }
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
            @keyframes shimmer {
                0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
                50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
                100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            }
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
                20%, 40%, 60%, 80% { transform: translateX(2px); }
            }
            @keyframes glow {
                0%, 100% { box-shadow: 0 0 5px rgba(27, 94, 32, 0.5); }
                50% { box-shadow: 0 0 20px rgba(27, 94, 32, 0.8); }
            }
            
            /* Enhanced search result highlighting */
            .search-result-item mark {
                background-color: rgba(27, 94, 32, 0.1);
                color: var(--primary-color);
                padding: 2px 4px;
                border-radius: var(--border-radius-sm);
                font-weight: var(--font-weight-semibold);
            }
            
            .search-result-item.highlighted mark {
                background-color: var(--primary-color);
                color: var(--text-inverse);
            }
            
            /* Modern focus states */
            .btn-primary:focus,
            .btn-secondary:focus,
            .control-btn:focus,
            .sidebar-toggle:focus {
                outline: 2px solid var(--primary-color);
                outline-offset: 2px;
            }
            
            /* Enhanced loading states */
            .loading-state {
                opacity: 0.6;
                pointer-events: none;
                position: relative;
            }
            
            .loading-state::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 20px;
                height: 20px;
                margin: -10px 0 0 -10px;
                border: 2px solid var(--border-light);
                border-top: 2px solid var(--primary-color);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            /* Interactive element enhancements */
            .interactive-element {
                transition: all var(--transition-fast);
            }
            
            .interactive-element:hover {
                transform: translateY(-1px);
                box-shadow: var(--shadow-md);
            }
            
            /* Glass morphism effect */
            .glass-effect {
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.18);
            }
            
            /* Gradient text */
            .gradient-text {
                background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
            
            /* Status indicators */
            .status-indicator {
                position: relative;
                display: inline-block;
            }
            
            .status-indicator::after {
                content: '';
                position: absolute;
                top: -2px;
                right: -2px;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                border: 2px solid var(--surface-color);
            }
            
            .status-indicator.online::after {
                background: var(--success-color);
                animation: pulse 2s infinite;
            }
            
            .status-indicator.offline::after {
                background: var(--error-color);
            }
            
            .status-indicator.loading::after {
                background: var(--warning-color);
                animation: pulse 1s infinite;
            }
            
            /* Enhanced error states */
            .error-state {
                animation: shake 0.5s ease-in-out;
                border-color: var(--error-color) !important;
            }
            
            .success-state {
                animation: glow 1s ease-in-out;
                border-color: var(--success-color) !important;
            }
            
            /* Notification stacking */
            .notification-success,
            .notification-error,
            .notification-warning,
            .notification-info {
                margin-bottom: var(--spacing-sm);
            }
            
            /* Progress bar enhancements */
            .progress-bar-striped .progress-fill::after {
                background-image: linear-gradient(
                    45deg,
                    rgba(255, 255, 255, 0.15) 25%,
                    transparent 25%,
                    transparent 50%,
                    rgba(255, 255, 255, 0.15) 50%,
                    rgba(255, 255, 255, 0.15) 75%,
                    transparent 75%,
                    transparent
                );
                background-size: 1rem 1rem;
                animation: progress-bar-stripes 1s linear infinite;
            }
            
            @keyframes progress-bar-stripes {
                0% { background-position: 1rem 0; }
                100% { background-position: 0 0; }
            }
            
            /* Connection quality indicator */
            .connection-quality {
                display: flex;
                align-items: center;
                gap: 2px;
            }
            
            .connection-bar {
                width: 3px;
                background: var(--border-light);
                border-radius: 1px;
                transition: background var(--transition-fast);
            }
            
            .connection-bar:nth-child(1) { height: 6px; }
            .connection-bar:nth-child(2) { height: 9px; }
            .connection-bar:nth-child(3) { height: 12px; }
            .connection-bar:nth-child(4) { height: 15px; }
            
            .connection-quality.excellent .connection-bar { background: var(--success-color); }
            .connection-quality.good .connection-bar:nth-child(-n+3) { background: var(--success-color); }
            .connection-quality.fair .connection-bar:nth-child(-n+2) { background: var(--warning-color); }
            .connection-quality.poor .connection-bar:nth-child(1) { background: var(--error-color); }
        `;
        document.head.appendChild(style);
        
        // Initialize performance monitoring
        const performanceMonitor = {
            startTime: Date.now(),
            loadTimes: {},
            
            mark(label) {
                this.loadTimes[label] = Date.now() - this.startTime;
                console.log(`â±ï¸ ${label}: ${this.loadTimes[label]}ms`);
            },
            
            getReport() {
                return {
                    totalTime: Date.now() - this.startTime,
                    breakdown: this.loadTimes
                };
            }
        };
        
        // Add to global scope for debugging
        window.performanceMonitor = performanceMonitor;
    </script>
</body>
</html>